<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MarketList — Deliverer Tracking</title>
  <style>
    :root{ --g1:#00a859; --g2:#ff8c00; --card-bg:#fff; --muted:#666; --accent:#1976d2; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:0}
    body{background:#fafafa;color:#111;min-height:100vh;display:flex;flex-direction:column}
    header{background:linear-gradient(135deg,var(--g1),var(--g2));padding:14px 18px;color:#fff;box-shadow:0 4px 14px rgba(0,0,0,0.08)}
    header .wrap{max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header .brand{display:flex;align-items:center;gap:10px;cursor:pointer}
    header .brand img{width:44px;height:44px;border-radius:8px}
    header h1{font-size:18px;margin:0}
    main{max-width:900px;margin:18px auto;padding:18px;width:100%}
    .card{background:var(--card-bg);border-radius:12px;padding:18px;box-shadow:0 6px 22px rgba(0,0,0,0.08);margin-bottom:18px}
    .small{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center}
    .col{flex:1}
    label{display:block;font-weight:700;margin-bottom:6px}
    input[type="text"], input[type="tel"], input[type="number"], select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;font-size:15px}
    button.btn{background:var(--g1);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    button.ghost{background:#fff;color:var(--g1);border:1px solid rgba(0,0,0,0.06)}
    .btn.warn{background:#ff7043}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .order-meta{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .meta-pill{background:#f3f3f3;padding:8px 10px;border-radius:8px;font-weight:700;color:#222}
    .status-badge{display:inline-block;padding:6px 10px;border-radius:10px;color:#fff;font-weight:800}
    .status-pending{background:#666}
    .status-accepted{background:var(--accent)}
    .status-delivering{background:var(--g1)}
    .status-delivered{background:green}
    .info-row{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .info-left{flex:1}
    .info-right{text-align:right;min-width:150px}
    .large{font-size:18px;font-weight:800;color:#111}
    .muted-small{font-size:13px;color:#666}
    footer{max-width:900px;margin:24px auto;padding:12px;text-align:center;color:#666;font-size:13px}
    @media (max-width:700px){ .row{flex-direction:column} .info-right{text-align:left} }
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="brand" onclick="window.location.href='index.html'">
      <img src="logo.png" alt="logo">
      <div>
        <h1>MarketList — Deliverer</h1>
        <div style="font-size:12px;opacity:0.95">Accept, Navigate & Deliver</div>
      </div>
    </div>
    <div>
      <button class="btn" id="openOrdersBtn">My Orders</button>
    </div>
  </div>
</header>

<main>
  <!-- Tracking code loader -->
  <div class="card" id="loaderCard" aria-live="polite">
    <label for="trackInput">Enter Tracking Code</label>
    <div class="row">
      <div class="col">
        <input id="trackInput" type="text" placeholder="ML-123456 or paste tracking code">
      </div>
      <div style="width:160px">
        <button id="loadOrderBtn" class="btn">Load Order</button>
      </div>
    </div>
    <div style="margin-top:10px" class="small muted">Tip: You can also scan or paste a tracking code from the customer or your dashboard.</div>
  </div>

  <!-- Order card (populated after load) -->
  <div class="card" id="orderCard" style="display:none;" aria-live="polite">
    <div class="row">
      <div class="col">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--g1),var(--g2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800">D</div>
          <div>
            <div id="custName" style="font-size:16px;font-weight:800">Customer Name</div>
            <div class="muted-small" id="custPhone">+233XXXXXXXXX</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <label style="font-size:13px;color:#444;margin-bottom:6px">Location</label>
          <div id="custLocation" class="small muted">Loading address...</div>
        </div>

        <div style="margin-top:12px">
          <label style="font-size:13px;color:#444;margin-bottom:6px">Order Status</label>
          <div id="orderStatusWrap"><span id="orderStatusBadge" class="status-badge status-pending">Pending</span></div>
        </div>

      </div>

      <div class="info-right">
        <div class="muted-small">Delivery Fee</div>
        <div class="large" id="displayDeliveryFee">₵0.00</div>

        <div style="margin-top:12px" class="muted-small">Customer Budget / Cash</div>
        <div class="large" id="displayBudget">₵0.00</div>

        <div style="margin-top:12px" class="muted-small">Tracking</div>
        <div id="displayTracking" class="muted-small">ML-000000</div>

        <div class="order-meta" style="margin-top:12px">
          <div class="meta-pill" id="displayCategory">—</div>
          <div class="meta-pill" id="displayTime">—</div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button id="acceptBtn" class="btn">Accept Order</button>
      <button id="navigateBtn" class="btn" style="background:var(--accent)">Navigate Now</button>
      <button id="callBtn" class="ghost" style="border:1px solid #ddd">Call Customer</button>
      <button id="shareBtn" class="ghost" style="border:1px solid #ddd">Share (WhatsApp)</button>
      <button id="deliveredBtn" class="btn warn" style="display:none">Mark Delivered</button>
    </div>

    <div style="margin-top:12px" class="small muted" id="orderNotes">Order loaded — review and accept to navigate.</div>
  </div>

  <!-- Quick fallback / no-order card -->
  <div id="emptyCard" class="card" style="display:none">
    <div class="small muted">No order loaded. Enter a tracking code above or open an order from <strong>My Orders</strong>.</div>
  </div>
</main>

<footer>
  © 2025 MarketList — Deliverer • Built to work with map.html & index.html
</footer>

<script>
  // Utilities
  function qs(id){ return document.getElementById(id); }
  function formatGhs(n){ return '₵' + (parseFloat(n||0).toFixed(2)); }
  function nowHuman(ts){ try{ const d = ts ? new Date(ts) : new Date(); return d.toLocaleString(); }catch(e){return ''} }

  // DOM references
  const loadOrderBtn = qs('loadOrderBtn');
  const trackInput = qs('trackInput');
  const orderCard = qs('orderCard');
  const emptyCard = qs('emptyCard');
  const orderNotes = qs('orderNotes');

  const custName = qs('custName');
  const custPhone = qs('custPhone');
  const custLocation = qs('custLocation');
  const displayDeliveryFee = qs('displayDeliveryFee');
  const displayBudget = qs('displayBudget');
  const displayTracking = qs('displayTracking');
  const displayCategory = qs('displayCategory');
  const displayTime = qs('displayTime');

  const acceptBtn = qs('acceptBtn');
  const navigateBtn = qs('navigateBtn');
  const deliveredBtn = qs('deliveredBtn');
  const callBtn = qs('callBtn');
  const shareBtn = qs('shareBtn');

  let currentOrder = null;

  // Load orders from localStorage
  function readStoredOrders(){
    try {
      return JSON.parse(localStorage.getItem('marketOrders') || '[]');
    } catch(e){ return []; }
  }
  function saveStoredOrders(arr){
    try { localStorage.setItem('marketOrders', JSON.stringify(arr || [])); } catch(e){}
  }

  function findOrderByTracking(code){
    if(!code) return null;
    const orders = readStoredOrders();
    const found = orders.find(o => (o.tracking && String(o.tracking).toUpperCase()===String(code).toUpperCase()));
    if(found) return found;
    // fallback: check session last order
    try {
      const last = JSON.parse(sessionStorage.getItem('ml_last_order') || 'null');
      if(last && last.tracking && String(last.tracking).toUpperCase()===String(code).toUpperCase()) return last;
    } catch(e){}
    return null;
  }

  function showOrder(o){
    if(!o){ orderCard.style.display='none'; emptyCard.style.display='block'; return; }
    currentOrder = o;
    orderCard.style.display='block';
    emptyCard.style.display='none';

    // customer info
    custName.textContent = o.name || 'Customer';
    custPhone.textContent = o.phone || '';
    displayTracking.textContent = o.tracking || '';

    // location: prefer available coords -> try ml_saved_location if not present inside order
    let userLabel = o.location || '';
    let addrShown = userLabel || 'Unknown location';
    if(o.customerLat && o.customerLng && (!userLabel || userLabel==='')){
      addrShown = `${parseFloat(o.customerLat).toFixed(5)}, ${parseFloat(o.customerLng).toFixed(5)}`;
    } else if(!userLabel){
      // try shared ml_saved_location
      try {
        const saved = JSON.parse(localStorage.getItem('ml_saved_location') || 'null');
        if(saved && saved.userLabel) addrShown = saved.userLabel;
        else if(saved && saved.userLat && saved.userLng) addrShown = `${parseFloat(saved.userLat).toFixed(5)}, ${parseFloat(saved.userLng).toFixed(5)}`;
      } catch(e){}
    }
    custLocation.textContent = addrShown;

    // financials
    displayDeliveryFee.textContent = formatGhs(o.deliveryFee || o.deliveryFee === 0 ? o.deliveryFee : (o.deliveryFee || 0));
    displayBudget.textContent = formatGhs(o.total || o.budget || 0);

    // category & time
    displayCategory.textContent = (o.category && o.category.length) ? o.category : '—';
    displayTime.textContent = nowHuman(o.createdAt || o.savedAt || Date.now());

    // status
    setStatus(o.status || 'Pending');

    // call/share buttons
    callBtn.onclick = () => {
      if(!o.phone){ alert('No phone number for customer'); return; }
      window.location.href = `tel:${o.phone}`;
    };
    shareBtn.onclick = () => {
      const msg = `Order: ${o.tracking}\nCustomer: ${o.name}\nPhone: ${o.phone}\nLocation: ${addrShown}\nTotal: ${formatGhs(o.total || o.budget || 0)}\nDelivery Fee: ${formatGhs(o.deliveryFee || 0)}`;
      const wa = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(wa, '_blank');
    };

    // delivered button show/hide depending status
    if((o.status || '').toLowerCase() === 'delivered'){
      deliveredBtn.style.display='none';
      acceptBtn.style.display='none';
      navigateBtn.style.display='inline-block';
    } else {
      deliveredBtn.style.display='inline-block';
      acceptBtn.style.display='inline-block';
      navigateBtn.style.display='inline-block';
    }
  }

  function setStatus(status){
    const badge = qs('orderStatusBadge');
    if(!badge) return;
    const s = (status || '').toString().toLowerCase();
    badge.className = 'status-badge';
    badge.textContent = (status || '').toString();
    if(s === 'pending') badge.classList.add('status-pending');
    else if(s === 'accepted') badge.classList.add('status-accepted');
    else if(s === 'delivering') badge.classList.add('status-delivering');
    else if(s === 'delivered') badge.classList.add('status-delivered');
    else badge.classList.add('status-pending');
  }

  // Update order in storage by tracking code
  function updateOrderInStorage(updatedOrder){
    try {
      const all = readStoredOrders();
      const idx = all.findIndex(x => x.tracking && String(x.tracking).toUpperCase()===String(updatedOrder.tracking).toUpperCase());
      if(idx >= 0){
        all[idx] = Object.assign({}, all[idx], updatedOrder);
      } else {
        all.push(updatedOrder);
      }
      saveStoredOrders(all);
      // keep session as well
      sessionStorage.setItem('ml_last_order', JSON.stringify(updatedOrder));
    } catch(e){
      console.error('updateOrderInStorage', e);
    }
  }

  // Load order (button)
  loadOrderBtn.addEventListener('click', () => {
    const code = (trackInput.value||'').trim();
    if(!code){ alert('Enter tracking code'); return; }
    const found = findOrderByTracking(code);
    if(!found){ alert('Order not found. Make sure the code is correct and the order exists in the device storage.'); return; }
    // normalize order
    if(!found.status) found.status = 'Pending';
    showOrder(found);
    orderNotes.textContent = 'Order loaded — review and accept to navigate.';
  });

  // Accept order
  acceptBtn.addEventListener('click', ()=>{
    if(!currentOrder){ alert('Load an order first'); return; }
    currentOrder.status = 'Accepted';
    updateOrderInStorage(currentOrder);
    setStatus('Accepted');
    orderNotes.textContent = 'Order accepted. Tap Navigate Now to begin delivery.';
    // optionally open navigation automatically? we wait for deliverer to click Navigate
  });

  // Mark delivered
  deliveredBtn.addEventListener('click', ()=>{
    if(!currentOrder){ alert('Load an order first'); return; }
    if(!confirm('Mark this order as DELIVERED?')) return;
    currentOrder.status = 'Delivered';
    currentOrder.deliveredAt = Date.now();
    updateOrderInStorage(currentOrder);
    setStatus('Delivered');
    orderNotes.textContent = 'Order marked as delivered. Nice work!';
    // Optionally notify customer via WhatsApp
    const send = confirm('Send a delivery confirmation to customer via WhatsApp?');
    if(send){
      const msg = `Hello ${currentOrder.name}, your order ${currentOrder.tracking} has been delivered. Thank you!`;
      const wa = `https://wa.me/${currentOrder.phone ? currentOrder.phone.replace(/\D/g,'') : ''}?text=${encodeURIComponent(msg)}`;
      window.open(wa, '_blank');
    }
  });

  // Navigate Now: prepare payload and redirect to map.html in deliverer mode
  navigateBtn.addEventListener('click', ()=>{
    if(!currentOrder){ alert('Load an order first'); return; }
    // ensure customer coordinates exist
    // Priority: order.customerLat/customerLng -> order.customer coordinates in order object
    let customerLat = (currentOrder.customerLat != null) ? parseFloat(currentOrder.customerLat) : null;
    let customerLng = (currentOrder.customerLng != null) ? parseFloat(currentOrder.customerLng) : null;
    let marketLat = (currentOrder.marketLat != null) ? parseFloat(currentOrder.marketLat) : null;
    let marketLng = (currentOrder.marketLng != null) ? parseFloat(currentOrder.marketLng) : null;

    // fallback to ml_saved_location
    try {
      const saved = JSON.parse(localStorage.getItem('ml_saved_location') || 'null');
      if((customerLat == null || isNaN(customerLat)) && saved && saved.userLat) customerLat = parseFloat(saved.userLat);
      if((customerLng == null || isNaN(customerLng)) && saved && saved.userLng) customerLng = parseFloat(saved.userLng);
      if((marketLat == null || isNaN(marketLat)) && saved && saved.marketLat) marketLat = parseFloat(saved.marketLat);
      if((marketLng == null || isNaN(marketLng)) && saved && saved.marketLng) marketLng = parseFloat(saved.marketLng);
    } catch(e){ /* ignore */ }

    if(customerLat == null || customerLng == null){
      if(!confirm('Customer coordinates are missing. You can still open the map and use the address, but routing may not work. Open map now?')) {
        return;
      }
    }

    // Build navigation payload for map.html
    const payload = {
      mode: 'deliverer',
      tracking: currentOrder.tracking || null,
      customer_lat: isFinite(customerLat) ? customerLat : null,
      customer_lng: isFinite(customerLng) ? customerLng : null,
      market_lat: isFinite(marketLat) ? marketLat : null,
      market_lng: isFinite(marketLng) ? marketLng : null,
      // deliverer coords will be picked live by map.html via geolocation
      createdAt: Date.now()
    };
    try {
      localStorage.setItem('deliverer_navigation', JSON.stringify(payload));
    } catch(e){ console.error('failed write deliverer_navigation', e); }

    // update status to Delivering
    currentOrder.status = 'Delivering';
    updateOrderInStorage(currentOrder);
    setStatus('Delivering');
    orderNotes.textContent = 'Opening navigation...';

    // redirect to map.html with mode param
    window.location.href = 'map.html?mode=deliverer';
  });

 // "My Orders" quick open - shows local storage list in a new window
qs('openOrdersBtn').addEventListener('click', () => {
  const orders = readStoredOrders();
  if (!orders || !orders.length) {
    alert('No stored orders on this device.');
    return;
  }

  const w = window.open('', '_blank', 'width=600,height=800');
  w.document.write('<h3>Stored Orders</h3><ul>');

  orders.forEach(o => {
    w.document.write(`
      <li style="margin:8px 0;padding:6px;border-bottom:1px solid #eee">
        <strong>${o.tracking || ''}</strong> —
        ${o.name || ''} —
        ${o.phone || ''} —
        <button onclick="window.opener.loadTrackingFromPopup('${o.tracking}'); window.close();">Open</button>
      </li>
    `);
  });

  w.document.write('</ul>');
  w.document.close();
});

  // Called from popup to load tracking code
  function loadTrackingFromPopup(code){
    trackInput.value = code;
    loadOrderBtn.click();
  }

  window.loadTrackingFromPopup = loadTrackingFromPopup;
  window.selectTracking = loadTrackingFromPopup;

  // If page opened with ?t=ML-12345 param then auto-load
  (function handleQueryParamLoad(){
    try {
      const params = new URLSearchParams(window.location.search);
      const t = params.get('t') || params.get('tracking') || null;
      if(t){
        trackInput.value = t;
        setTimeout(() => loadOrderBtn.click(), 250);
      }
    } catch(e){}
  })();

  // On load, if there's session last order prefill
  (function tryPrefillFromSession(){
    try {
      const last = JSON.parse(sessionStorage.getItem('ml_last_order') || 'null');
      if(last && last.tracking){
        trackInput.value = last.tracking;
      }
    } catch(e){}
  })();

  // Expose small debug tools
  window._ml_tracking_debug = {
    findOrderByTracking,
    readStoredOrders
  };

</script>
</body>
</html>
