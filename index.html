<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MarketList ‚Äî Order / Delivery</title>

  <style>
    :root{
      --accent:#00a859;
      --accent-2:#1976d2;
      --bg:#f7f7f7;
      --card:#fff;
      --muted:#666;
      --danger:#d32f2f;
    }
    *{box-sizing:border-box;font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial}
    body{margin:0;background:linear-gradient(180deg,#f3fbf6,#fff);color:#111}
    .container{max-width:980px;margin:16px auto;padding:12px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    header h1{margin:0;font-size:20px}
    .row{display:flex;gap:12px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .col{flex:1;min-width:180px}
    label{display:block;font-weight:700;margin-bottom:6px}
    input[type="text"], input[type="number"], select, textarea {
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;font-size:15px;
    }
    textarea{min-height:80px;resize:vertical}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#fff;border:1px solid #eee}
    .btn.warn{background:var(--danger);color:#fff}
    .small{font-size:13px;color:var(--muted)}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.06)}
    .flex{display:flex;gap:10px;align-items:center}
    .right{text-align:right}
    .meta{font-size:13px;color:var(--muted)}
    .kpi{font-weight:900}

    /* popup (white modern) */
    .popup-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:3000}
    .popup-backdrop.show{display:flex}
    .popup{width:92%;max-width:520px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 30px 80px rgba(0,0,0,0.25)}
    .popup h3{margin:0 0 10px 0;font-size:18px}
    .popup .big{font-size:18px;font-weight:900;margin:10px 0}
    .popup .row{margin-top:8px}
    .copyHint{font-size:13px;color:var(--muted);margin-top:6px}

    /* responsive */
    @media (max-width:720px){
      .row { flex-direction: column; align-items:stretch; }
      header{flex-direction:column;align-items:flex-start;gap:8px}
      .right{text-align:left}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>MarketList ‚Äî Place Order</h1>
        <div class="small">Choose market, set your location, then send your list.</div>
      </div>
      <div class="right">
        <button class="btn ghost" id="selectOnMapBtn">Select on Map</button>
      </div>
    </header>

    <!-- Main form -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label for="userLocationInput">Your location</label>
          <input id="userLocationInput" type="text" placeholder="Tap 'Track Location' or return from map" readonly>
          <div style="margin-top:8px" class="flex">
            <button class="btn primary" id="trackLocationBtn">Track Location</button>
            <button class="btn ghost" id="pastePlusBtn" title="Paste plus code (if any)">Paste Plus Code</button>
            <div style="flex:1" class="small">You can drag your pin on the map after selecting it.</div>
          </div>
        </div>

        <div class="col">
          <label for="marketLocationInput">Market / Mall</label>
          <input id="marketLocationInput" type="text" placeholder="Select market on map" readonly>
          <div class="small" style="margin-top:8px">Market name comes from the place you selected on the map.</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label for="category">Category</label>
          <select id="category">
            <option value="">-- Select Category --</option>
            <option value="malls">üõçÔ∏è Malls & Shopping Centres</option>
            <option value="markets">üß∫ Markets</option>
            <option value="supermarkets">üõí Supermarkets</option>
            <option value="restaurants">üçΩ Restaurants & Food</option>
            <option value="electronics">üéß Electronics & Gadgets</option>
            <option value="clothing">üëó Clothing & Fashion</option>
            <option value="shoes">üëü Shoes & Accessories</option>
            <option value="baby">üçº Baby & Kids</option>
            <option value="home">üè† Home & Furniture</option>
            <option value="beauty">üíÑ Beauty & Cosmetics</option>
            <option value="hardware">üîß Hardware & Building Materials</option>
            <option value="convenience">üßÉ Drinks & Convenience Stores</option>
            <option value="pharmacy">üíä Pharmacy & Health</option>
            <option value="party">üéâ Party & Event Supplies</option>
            <option value="books">üìö Books & Stationery</option>
          </select>
          <div id="categoryEcho" class="small" style="margin-top:6px">Selected: <span id="categorySelected">--</span></div>
        </div>

        <div class="col">
          <label for="budget">Budget (‚Çµ)</label>
          <input id="budget" type="number" min="0" placeholder="Enter budget amount">
        </div>
      </div>

      <div style="margin-top:12px">
        <label for="items">Items (one per line)</label>
        <textarea id="items" placeholder="e.g. Milo&#10;Milk&#10;Bread"></textarea>
      </div>

      <div class="row" style="margin-top:12px;align-items:center;">
        <div class="col">
          <div class="small">Distance (KM)</div>
          <div class="kpi" id="distanceKm">--</div>
        </div>
        <div class="col">
          <div class="small">Delivery fee</div>
          <div class="kpi" id="deliveryFee">--</div>
        </div>
        <div class="col right">
          <div class="small">Tracking</div>
          <div class="kpi" id="trackingCodeDisplay">--</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end;">
        <button class="btn ghost" id="saveLocationToLocal">Save (Local)</button>
        <button class="btn primary" id="sendListBtn">Send Your List Now</button>
      </div>
    </div>

  </div>

  <!-- POPUP: Tracking / WhatsApp -->
  <div class="popup-backdrop" id="trackingPopup" aria-hidden="true">
    <div class="popup" role="dialog" aria-modal="true" aria-label="Your Tracking Code">
      <h3>Your Tracking Code</h3>
      <div class="big" id="popupTracking">--</div>

      <div class="row">
        <div style="flex:1">
          <button class="btn ghost" id="copyTrackBtn">Copy</button>
        </div>
        <div style="flex:1;text-align:right">
          <button class="btn primary" id="continueWhatsBtn">Continue to WhatsApp</button>
        </div>
      </div>

      <div class="copyHint small" id="copyHint">Click Copy, then Continue to WhatsApp to send your order.</div>

      <div style="margin-top:12px;text-align:right">
        <button class="btn" id="cancelPopup">Cancel</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ====== Config / constants ======
  const WHATSAPP_NUMBER = '233537351866'; // as provided
  const POPUP_TITLE = 'Your Tracking Code'; // D selected
  const BASE_FEE = 2.00;      // base fee in ‚Çµ (adjust if you want)
  const PER_KM_FEE = 1.00;    // fee per km in ‚Çµ (adjust)
  const MAP_RETURN_KEY = 'ml_saved_location'; // map.html should write this key

  // ====== Helpers ======
  const $ = id => document.getElementById(id);
  function nowStamp(){ return 'ML-' + Date.now().toString().slice(-6); }
  function toFixed(n, d=2){ return Number(n||0).toFixed(d); }

  // haversine - careful calculation
  function haversineKm(aLat,aLng,bLat,bLng){
    if(aLat==null || aLng==null || bLat==null || bLng==null) return null;
    const R=6371;
    const toRad = Math.PI/180;
    const dLat = (bLat - aLat) * toRad;
    const dLng = (bLng - aLng) * toRad;
    const sinLat = Math.sin(dLat/2);
    const sinLng = Math.sin(dLng/2);
    const A = sinLat*sinLat + Math.cos(aLat*toRad)*Math.cos(bLat*toRad)*sinLng*sinLng;
    const C = 2*Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
    return R * C;
  }

  // read possible saved location object from localStorage
  function readSavedLocation(){
    try {
      const raw = localStorage.getItem(MAP_RETURN_KEY);
      if(!raw) return null;
      const o = JSON.parse(raw);
      // normalize possible key names (map.html variants)
      const normalized = {
        userLat: o.userLat ?? o.user_lat ?? o.userLatitude ?? o.user_latitude ?? o.userLatLng?.lat ?? o.user?.lat ?? null,
        userLng: o.userLng ?? o.user_lng ?? o.userLongitude ?? o.user_longitude ?? o.userLatLng?.lng ?? o.user?.lng ?? null,
        userLabel: o.userLabel ?? o.user_label ?? o.userLabelText ?? o.userLabelStr ?? o.userLabel || o.user_name || null,
        marketLat: o.marketLat ?? o.market_lat ?? o.marketLatitude ?? o.market_latitude ?? o.market?.lat ?? null,
        marketLng: o.marketLng ?? o.market_lng ?? o.marketLongitude ?? o.market_longitude ?? o.market?.lng ?? null,
        marketLabel: o.marketLabel ?? o.market_label ?? o.marketLabelText ?? o.marketName ?? o.market?.title ?? null,
        distanceKm: o.distanceKm ?? o.distance_km ?? o.km ?? null,
        savedAt: o.savedAt ?? o.saved_at ?? null
      };
      // attempt numeric conversion
      if(normalized.userLat != null) normalized.userLat = Number(normalized.userLat);
      if(normalized.userLng != null) normalized.userLng = Number(normalized.userLng);
      if(normalized.marketLat != null) normalized.marketLat = Number(normalized.marketLat);
      if(normalized.marketLng != null) normalized.marketLng = Number(normalized.marketLng);
      return normalized;
    } catch(e){
      console.warn('readSavedLocation failed', e);
      return null;
    }
  }

  // write local order summary to localStorage (simple)
  function saveOrderLocally(orderObj){
    try {
      const orders = JSON.parse(localStorage.getItem('marketOrders') || '[]');
      const idx = orders.findIndex(x => (x.tracking && String(x.tracking) === String(orderObj.tracking)));
      if(idx >= 0) orders[idx] = Object.assign({}, orders[idx], orderObj);
      else orders.push(orderObj);
      localStorage.setItem('marketOrders', JSON.stringify(orders));
      sessionStorage.setItem('ml_last_order', JSON.stringify(orderObj));
    } catch(e){ console.warn('saveOrderLocally error', e); }
  }

  // ====== UI refs ======
  const userLocationInput = $('userLocationInput');
  const marketLocationInput = $('marketLocationInput');
  const trackLocationBtn = $('trackLocationBtn');
  const selectOnMapBtn = $('selectOnMapBtn');
  const pastePlusBtn = $('pastePlusBtn');

  const category = $('category');
  const categorySelected = $('categorySelected');
  const budget = $('budget');
  const items = $('items');

  const distanceKmEl = $('distanceKm');
  const deliveryFeeEl = $('deliveryFee');
  const trackingDisplay = $('trackingCodeDisplay');

  const saveLocationToLocal = $('saveLocationToLocal');
  const sendListBtn = $('sendListBtn');

  // popup refs
  const trackingPopup = $('trackingPopup');
  const popupTracking = $('popupTracking');
  const copyTrackBtn = $('copyTrackBtn');
  const continueWhatsBtn = $('continueWhatsBtn');
  const cancelPopup = $('cancelPopup');
  const copyHint = $('copyHint');

  // ====== internal state ======
  let currentState = {
    userLat:null, userLng:null, userLabel:'',
    marketLat:null, marketLng:null, marketLabel:'',
    distanceKm:null,
    trackingCode:null
  };

  // ====== initialization ======
  function init(){
    // category echo
    categorySelected.textContent = category.options[category.selectedIndex].text || '--';
    category.addEventListener('change', ()=> {
      categorySelected.textContent = category.options[category.selectedIndex].text || '--';
    });

    // generate or read tracking code
    const existing = sessionStorage.getItem('ml_tracking_code');
    if(existing){ currentState.trackingCode = existing; }
    else { currentState.trackingCode = nowStamp(); sessionStorage.setItem('ml_tracking_code', currentState.trackingCode); }
    trackingDisplay.textContent = currentState.trackingCode;

    // read any saved location (returned from map.html)
    applySavedLocationIfAny();

    // wire buttons
    bindUi();
  }

  // ====== Apply saved location from localStorage (called on load and on focus) ======
  function applySavedLocationIfAny(){
    const saved = readSavedLocation();
    if(!saved) return;
    let changed=false;

    // if we have user lat/lng
    if(saved.userLat != null && saved.userLng != null){
      currentState.userLat = saved.userLat;
      currentState.userLng = saved.userLng;
      if(saved.userLabel) currentState.userLabel = saved.userLabel;
      // update input text
      userLocationInput.value = saved.userLabel || `${toFixed(saved.userLat,5)}, ${toFixed(saved.userLng,5)}`;
      changed=true;
    }

    // market fields
    if(saved.marketLat != null && saved.marketLng != null){
      currentState.marketLat = saved.marketLat;
      currentState.marketLng = saved.marketLng;
      if(saved.marketLabel) currentState.marketLabel = saved.marketLabel;
      marketLocationInput.value = saved.marketLabel || `${toFixed(saved.marketLat,5)}, ${toFixed(saved.marketLng,5)}`;
      changed=true;
    }

    // compute distance if both available
    if(currentState.userLat != null && currentState.userLng != null && currentState.marketLat != null && currentState.marketLng != null){
      const d = haversineKm(currentState.userLat, currentState.userLng, currentState.marketLat, currentState.marketLng);
      currentState.distanceKm = d;
      distanceKmEl.textContent = (d!=null) ? toFixed(d,2) + ' km' : '--';
      const fee = computeFee(d);
      deliveryFeeEl.textContent = '‚Çµ ' + toFixed(fee,2);
      // if saved distance exists, prefer it as well
      if(saved.distanceKm && !isNaN(Number(saved.distanceKm))){
        // optional: you can choose to use saved.distanceKm instead
      }
    }

    if(changed) {
      // ensure tracking displayed
      trackingDisplay.textContent = currentState.trackingCode;
    }
  }

  // compute delivery fee - using BASE_FEE + PER_KM_FEE * distance (you can change formula)
  function computeFee(distanceKm){
    if(distanceKm == null || isNaN(distanceKm)) return BASE_FEE;
    return BASE_FEE + (PER_KM_FEE * Number(distanceKm));
  }

  // ====== Bind UI ======
  function bindUi(){
    // Select on map redirects to map.html
    selectOnMapBtn.addEventListener('click', ()=>{
      // Save any existing state before leaving (optional)
      // If you prefer not to save, comment out below
      try {
        // store a quick snapshot so map.html can pick up initial context if needed
        localStorage.setItem('ml_prev_state', JSON.stringify({
          userLat: currentState.userLat, userLng: currentState.userLng, userLabel: currentState.userLabel,
          marketLat: currentState.marketLat, marketLng: currentState.marketLng, marketLabel: currentState.marketLabel
        }));
      } catch(e){}
      window.location.href = 'map.html';
    });

    // detect location
    trackLocationBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
      trackLocationBtn.disabled = true;
      trackLocationBtn.textContent = 'Detecting‚Ä¶';
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        currentState.userLat = lat; currentState.userLng = lng;
        currentState.userLabel = `You (${toFixed(lat,5)}, ${toFixed(lng,5)})`;
        userLocationInput.value = currentState.userLabel;
        // recalc distance if market set
        if(currentState.marketLat != null && currentState.marketLng != null){
          const d = haversineKm(lat, lng, currentState.marketLat, currentState.marketLng);
          currentState.distanceKm = d;
          distanceKmEl.textContent = toFixed(d,2) + ' km';
          deliveryFeeEl.textContent = '‚Çµ ' + toFixed(computeFee(d),2);
        }
        trackLocationBtn.disabled = false;
        trackLocationBtn.textContent = 'Track Location';
      }, err => {
        alert('Unable to detect: ' + (err.message || 'error'));
        trackLocationBtn.disabled = false;
        trackLocationBtn.textContent = 'Track Location';
      }, { enableHighAccuracy:true, timeout:8000, maximumAge:10000 });
    });

    // Paste plus code helper - attempts to read clipboard (user must allow)
    pastePlusBtn.addEventListener('click', async ()=>{
      try {
        const text = await navigator.clipboard.readText();
        if(!text){ alert('Clipboard empty'); return; }
        // naive: if looks like a plus code e.g. '7PR9+V8 Accra' or similar
        const isPlus = text.includes('+') || text.length < 30;
        userLocationInput.value = text;
        // store as userLabel (coordinates conversion not handled here)
        currentState.userLabel = text;
      } catch(e){
        alert('Clipboard access denied. Paste manually.');
      }
    });

    // Save location locally (explicit)
    saveLocationToLocal.addEventListener('click', ()=>{
      // create order skeleton (no server)
      const order = {
        tracking: currentState.trackingCode,
        name: '', phone: '',
        userLat: currentState.userLat, userLng: currentState.userLng, customerLabel: currentState.userLabel,
        marketLat: currentState.marketLat, marketLng: currentState.marketLng, marketLabel: currentState.marketLabel,
        distanceKm: currentState.distanceKm,
        deliveryFee: computeFee(currentState.distanceKm),
        budget: Number(budget.value || 0),
        category: category.value || '',
        items: (items.value || '').split('\n').map(s=>s.trim()).filter(Boolean),
        status: 'Pending',
        createdAt: Date.now()
      };
      saveOrderLocally(order);
      alert('Saved locally.');
    });

    // Send list ‚Äî show popup every time
    sendListBtn.addEventListener('click', ()=>{
      // ensure we have a tracking code
      if(!currentState.trackingCode){
        currentState.trackingCode = nowStamp();
        sessionStorage.setItem('ml_tracking_code', currentState.trackingCode);
        trackingDisplay.textContent = currentState.trackingCode;
      }
      // populate popup
      popupTracking.textContent = currentState.trackingCode;
      copyHint.textContent = 'Copy the code, then continue to WhatsApp to send your order.';
      trackingPopup.classList.add('show');
      trackingPopup.setAttribute('aria-hidden','false');
    });

    // copy tracking
    copyTrackBtn.addEventListener('click', async ()=>{
      try {
        await navigator.clipboard.writeText(currentState.trackingCode || '');
        copyHint.textContent = 'Copied to clipboard!';
      } catch(e){
        // fallback
        const tmp = document.createElement('input');
        tmp.value = currentState.trackingCode || '';
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand('copy');
        tmp.remove();
        copyHint.textContent = 'Copied (fallback).';
      }
    });

    // continue to whatsapp
    continueWhatsBtn.addEventListener('click', ()=>{
      // build message format B (professional)
      const name = (window.prompt && sessionStorage.getItem('ml_customer_name')) || '';
      const phone = (window.prompt && sessionStorage.getItem('ml_customer_phone')) || '';
      const customerLabel = currentState.userLabel || userLocationInput.value || '--';
      const marketLabel = currentState.marketLabel || marketLocationInput.value || '--';
      const catText = category.options[category.selectedIndex] ? category.options[category.selectedIndex].text : '';
      const itemsList = (items.value || '').split('\n').map(s=>s.trim()).filter(Boolean);

      const msgLines = [];
      msgLines.push('üì¶ NEW ORDER REQUEST');
      msgLines.push('');
      msgLines.push('üî¢ Tracking Code: ' + (currentState.trackingCode || '--'));
      msgLines.push('');
      msgLines.push('üë§ Customer Info');
      msgLines.push('Name: ' + (name || '‚Äî'));
      msgLines.push('Phone: ' + (phone || '‚Äî'));
      msgLines.push('Location: ' + customerLabel);
      msgLines.push('');
      msgLines.push('üõç Market Selected');
      msgLines.push(marketLabel);
      msgLines.push('');
      msgLines.push('üí≥ Order Details');
      msgLines.push('Budget: ‚Çµ ' + (Number(budget.value || 0)).toFixed(2));
      msgLines.push('Category: ' + (catText || '--'));
      msgLines.push('Distance: ' + (currentState.distanceKm != null ? toFixed(currentState.distanceKm,2) + ' km' : '--'));
      msgLines.push('Delivery fee: ‚Çµ ' + toFixed(computeFee(currentState.distanceKm),2));
      msgLines.push('');
      msgLines.push('üìù Items Wanted');
      if(itemsList.length){
        itemsList.forEach(it => msgLines.push('- ' + it));
      } else {
        msgLines.push('- (no items provided)');
      }
      msgLines.push('');
      msgLines.push('Please confirm availability and respond.');

      const text = msgLines.join('\n');
      // encode and open whatsapp
      const waUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=` + encodeURIComponent(text);
      // also save order locally (so we have a record)
      const order = {
        tracking: currentState.trackingCode,
        name: name, phone: phone,
        customerLabel: customerLabel,
        marketLabel: marketLabel,
        marketLat: currentState.marketLat, marketLng: currentState.marketLng,
        userLat: currentState.userLat, userLng: currentState.userLng,
        distanceKm: currentState.distanceKm,
        deliveryFee: computeFee(currentState.distanceKm),
        budget: Number(budget.value||0),
        category: category.value || '',
        items: itemsList,
        status: 'Pending',
        createdAt: Date.now()
      };
      saveOrderLocally(order);

      // close popup then open whatsapp
      trackingPopup.classList.remove('show');
      trackingPopup.setAttribute('aria-hidden','true');
      // small delay to allow user see copied hint
      setTimeout(()=> { window.open(waUrl, '_blank'); }, 250);
    });

    cancelPopup.addEventListener('click', ()=>{
      trackingPopup.classList.remove('show');
      trackingPopup.setAttribute('aria-hidden','true');
    });

    // When page becomes visible (user returns from map.html), re-check saved location
    window.addEventListener('focus', ()=> {
      // apply saved location if map returned
      applySavedLocationIfAny();
    });

    // Also try on load
    // A slight delay to allow map.html redirect write to localStorage
    window.addEventListener('DOMContentLoaded', ()=>{
      setTimeout(()=> { applySavedLocationIfAny(); }, 180);
    });

    // track for storage changes (some browsers/firefox emit storage events across tabs)
    window.addEventListener('storage', (ev)=> {
      if(ev.key === MAP_RETURN_KEY) {
        applySavedLocationIfAny();
      }
    });
  }

  // ====== small util for toFixed used in applySavedLocationIfAny ======
  function toFixed(v,d=5){ return Number(v||0).toFixed(d); }

  // run init
  init();

})();
</script>
</body>
</html>