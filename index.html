<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MarketList ‚Äî Home</title>

<style>
/* Global Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

/* Preloader */
#preloader {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.5s ease;
}
#preloader.hidden {
  opacity: 0;
  pointer-events: none;
}

.loader-ring {
  width: 120px; height: 120px;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
}
.loader-ring .ring {
  width: 120px; height: 120px;
  border: 6px solid #ccc;
  border-top-color: #00a859;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  position: absolute; top: 0; left: 0;
}
.loader-ring img {
  width: 60px; height: 60px;
  border-radius: 50%;
  position: relative;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Splash Screen */
#splash {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9998;
  flex-direction: column;
  font-size: 24px;
  color: #00a859;
  opacity: 0;
  transition: opacity 0.5s ease;
}
#splash.visible {
  opacity: 1;
}

/* Header */
.headerbar {
  background: #00a859;
  color: #fff;
  padding: 10px 20px;
}
.headerbar .inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.headerbar .brand {
  display: flex;
  align-items: center;
  cursor: pointer;
}
.headerbar .brand img {
  width: 40px;
  margin-right: 10px;
}
.headerbar .brand .title {
  font-size: 20px;
  font-weight: normal;
  color: #fff;
}
.headerbar nav a {
  color: #fff;
  margin-left: 20px;
  text-decoration: none;
  font-weight: bold;
  font-size: 13.5px;
}
.headerbar nav a:hover { opacity: 0.9; }
.headerbar nav a.active { text-decoration: underline; }

/* Slider */
.slider-box {
  position: relative;
  width: 100%;
  max-width: 700px;
  margin: 20px auto;
  overflow: hidden;
  border-radius: 15px;
}
.slider {
  display: flex;
  transition: transform 0.5s ease;
}
.slide {
  min-width: 100%;
}
.slide img {
  width: 100%;
  height: 300px;
  object-fit: cover;
  display: block;
}
.slider-dot-container {
  text-align: center;
  margin-top: 10px;
}
.slider-dot {
  width: 10px; height: 10px;
  background: #ccc;
  border-radius: 50%;
  display: inline-block;
  margin: 0 3px;
  cursor: pointer;
}
.slider-dot.active {
  background: #00a859;
}

/* Main content */
main.container {
  max-width: 700px;
  margin: 40px auto;
  padding: 20px;
}
.card {
  background: linear-gradient(135deg, #00a859, #ff8c00);
  color: #fff;
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.header-main {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
}
.header-main img {
  width: 60px;
  margin-right: 15px;
}
.header-main h1 {
  margin: 0;
}
.slogan {
  font-style: normal;
  font-size: 0.9em;
}

/* Forms */
form label {
  display: block;
  margin-top: 15px;
  font-weight: bold;
  color: #fff;
}
form input, form select, form textarea {
  width: 100%;
  padding: 10px;
  margin-top: 5px;
  border: none;
  border-radius: 8px;
  font-size: 15px;
}
textarea {
  height: 80px;
  resize: vertical;
}

.row {
  display: flex;
  gap: 10px;
}
.row .col { flex: 1; }

.transparent-box {
  background: rgba(255,255,255,0.95);
  color: #000;
  padding: 20px;
  border-radius: 12px;
  margin-top: 15px;
  font-weight: bold;
  box-shadow: 0 4px 15px rgba(0,0,0,0.25);
}

/* Buttons */
.send-whatsapp {
  display: block;
  width: 100%;
  text-align: center;
  background-color: #25D366;
  color: white;
  font-weight: bold;
  padding: 15px;
  margin-top: 25px;
  border-radius: 30px;
  text-decoration: none;
  transition: background-color 0.3s ease;
}
.send-whatsapp:hover { background-color: #1ebe5b; }

footer.footer {
  text-align: center;
  padding: 15px;
  background: #eee;
  margin-top: 40px;
  color: #333;
}

/* Saved Location Card */
#savedCard {
  background: #fff;
  color: #111;
  padding: 14px;
  border-radius: 10px;
  margin-top: 12px;
  box-shadow: 0 8px 26px rgba(0,0,0,0.12);
  display: none;
}
#savedCard h3 {
  margin: 0 0 8px 0;
  color: #00a859;
}
#savedCard .row {
  display: flex;
  gap: 10px;
  align-items: center;
}
#savedCard .left { flex: 1; }
#savedCard .right {
  text-align: right;
  min-width: 180px;
}
#savedCard .distanceBadge {
  font-weight: 800;
  color: #333;
}

/* Hidden fields */
.hidden { display: none !important; }

/* Chatbot */
.chatbot-btn {
  position: fixed;
  bottom: 25px;
  right: 25px;
  width: 60px; height: 60px;
  background: #fff;
  color: #00a859;
  border-radius: 50%;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  cursor: pointer;
  animation: bounce 2s infinite;
  z-index: 10000;
}
@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-12px); }
  60% { transform: translateY(-6px); }
}

.chat-overlay {
  display: none;
  position: fixed;
  bottom: 100px;
  right: 30px;
  width: 320px;
  height: 400px;
  background: rgba(255,255,255,0.95);
  border-radius: 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  z-index: 10001;
  flex-direction: column;
  overflow: hidden;
}
.chat-header {
  background: #00a859;
  color: #fff;
  padding: 10px;
  text-align: center;
  font-weight: bold;
}
.chat-body {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  font-size: 14px;
  color: #333;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.chat-message {
  padding: 8px 10px;
  border-radius: 10px;
  max-width: 80%;
  word-wrap: break-word;
  font-size: 14px;
}
.user-msg { background: #f2f2f2; color: #000; align-self: flex-end; }
.bot-msg { background: #d8ecff; color: #000; align-self: flex-start; }
.chat-input { display: flex; border-top: 1px solid #ddd; }
.chat-input input { flex: 1; border: none; padding: 14px; font-size: 14px; outline: none; }
.chat-input button { background: #00a859; color: #fff; border: none; padding: 10px 15px; cursor: pointer; }

/* Responsive */
@media (max-width:700px){
  .row { flex-direction: column; }
}
  /* ============================
   Tracking Popup (Improved)
   ============================ */
#trackingPopup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.55);
  display: none; 
  justify-content: center;
  align-items: center;
  z-index: 99999;
  padding: 20px;
}

.tracking-card {
  background: #ffffff;
  width: 90%;
  max-width: 420px;
  padding: 25px;
  border-radius: 14px;
  text-align: center;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  animation: popIn 0.35s ease;
  font-family: system-ui, sans-serif;
}

@keyframes popIn {
  from {transform: scale(0.85); opacity: 0;}
  to {transform: scale(1); opacity: 1;}
}

.tracking-card h2 {
  margin-bottom: 12px;
  font-size: 20px;
  font-weight: 700;
}

.tracking-code-box {
  background: #f7f7f7;
  padding: 14px;
  border-radius: 10px;
  margin: 12px 0;
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 1px;
}

.popup-btn {
  width: 100%;
  padding: 14px;
  margin-top: 12px;
  border-radius: 10px;
  font-size: 16px;
  border: none;
  cursor: pointer;
  font-weight: 600;
}

.copy-btn {
  background: #ececec;
}

.wa-btn {
  background: #25D366;
  color: #fff;
}

.close-btn {
  margin-top: 10px;
  background: transparent;
  color: #444;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
}
</style>
</head>
<body>
<!-- Preloader -->
<div id="preloader" role="status" aria-live="polite">
  <div class="loader-ring" aria-hidden="true">
    <div class="ring" aria-hidden="true"></div>
    <img src="logo.png" alt="MarketList Logo">
  </div>
</div>

<!-- Splash Screen -->
<div id="splash" aria-hidden="true">
  <div>Welcome to <strong>MarketList</strong></div>
  <div>Bringing Market to Your Doorstep</div>
</div>

<!-- Header Navigation -->
<header class="headerbar">
  <div class="inner">
    <div class="brand" onclick="window.location.href='index.html'">
      <img src="logo.png" alt="MarketList Logo">
      <span class="title">MarketList</span>
    </div>
    <nav>
      <a href="index.html" class="active">Home</a>
      <a href="about.html">About</a>
      <a href="reviews.html">Reviews</a>
      <a href="assistant.html">Assistant</a>
      <a href="Tracking.html">Track Order</a>
      <a href="FAQ.html">FAQ</a>
    </nav>
  </div>
</header>

<!-- Image Slider -->
<div class="slider-box">
  <div class="slider" id="mainSlider">
    <div class="slide active"><img src="pexels-kampus-8476600.jpg" alt=""></div>
    <div class="slide"><img src="pexels-kenzero14-21582444.jpg" alt=""></div>
    <div class="slide"><img src="pexels-ninthgrid-2149521550-30688912.jpg" alt=""></div>
    <div class="slide"><img src="pexels-omotayo-tajudeen-1650120-3213283.jpg" alt=""></div>
    <div class="slide"><img src="pexels-barrytheoctopus-33624055.jpg" alt=""></div>
    <div class="slide"><img src="pexels-made-by-pixels-133605980-33364793.jpg" alt=""></div>
  </div>
  <div class="slider-dot-container" aria-hidden="true">
    <span class="slider-dot active"></span>
    <span class="slider-dot"></span>
    <span class="slider-dot"></span>
    <span class="slider-dot"></span>
    <span class="slider-dot"></span>
    <span class="slider-dot"></span>
  </div>
</div>

<!-- Main Form Section -->
<main class="container">
  <section class="card" role="form" aria-labelledby="formTitle">
    <div class="header-main">
      <img src="logo.png" alt="logo">
      <div>
        <h1 id="formTitle">MarketList</h1>
        <div class="slogan">Bringing Market to Your Doorstep</div>
      </div>
    </div>

    <form id="orderForm" onsubmit="return false;" aria-describedby="formHelp">
      <!-- User Details -->
      <label for="name">Full Name</label>
      <input id="name" type="text" placeholder="Enter your full name" required>

      <label for="contact">Contact Number</label>
      <input id="contact" type="tel" placeholder="055XXXXXXXX" required>

      <!-- Saved Location Summary Card -->
      <div id="savedCard" role="region" aria-live="polite">
        <h3>Saved Location</h3>
        <div class="row">
          <div class="left">
            <div><strong>Your Location</strong></div>
            <div id="savedUser" style="margin-top:6px;color:#444;">‚Äî</div>
            <div style="margin-top:10px;"><strong>Market</strong></div>
            <div id="savedMarket" style="margin-top:6px;color:#444;">‚Äî</div>
          </div>
          <div class="right">
            <div style="font-size:12px;color:#666;">Distance</div>
            <div class="distanceBadge" id="savedDistanceText">‚Äî</div>
            <div style="margin-top:8px; display:flex; gap:8px; justify-content:center;">
              <button type="button" class="send-whatsapp" style="background:#1976d2;padding:8px;border-radius:8px;font-weight:700;" id="selectOnMapBtn">Select on Map</button>
              <button type="button" class="send-whatsapp" style="background:#00a859;padding:8px;border-radius:8px;font-weight:700;" id="trackLocationBtn">Track Your Location</button>
            </div>
            <div style="margin-top:8px;">
              <button type="button" class="send-whatsapp" style="background:#ff7043;padding:8px;border-radius:8px;font-weight:700;" id="changeLocationBtn">Change Location</button>
            </div>
          </div>
        </div>

        <!-- Distance input (readonly) -->
        <div style="margin-top:12px;">
          <label for="distanceKm" style="color:#333;">Distance (KM)</label>
          <input id="distanceKm" type="text" readonly placeholder="Distance (KM)" style="background:#f7f7f7;color:#111;">
        </div>
      </div>

      <!-- Hidden Fields -->
      <input id="locationHidden" class="hidden" type="text">
      <input id="marketHidden" class="hidden" type="text">

      <!-- Category & Budget -->
      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label for="category" style="color:#fff;">Category</label>
          <select id="category" aria-label="Category">
            <option value="">-- Select Category --</option>
            <option value="malls">üõçÔ∏è Malls & Shopping Centres</option>
            <option value="markets">üß∫ Markets</option>
            <option value="supermarkets">üõí Supermarkets</option>
            <option value="restaurants">üçΩ Restaurants & Food</option>
            <option value="electronics">üéß Electronics & Gadgets</option>
            <option value="clothing">üëó Clothing & Fashion</option>
            <option value="shoes">üëü Shoes & Accessories</option>
            <option value="baby">üçº Baby & Kids</option>
            <option value="home">üè† Home & Furniture</option>
            <option value="beauty">üíÑ Beauty & Cosmetics</option>
            <option value="hardware">üîß Hardware & Building Materials</option>
            <option value="convenience">üßÉ Drinks & Convenience Stores</option>
            <option value="pharmacy">üíä Pharmacy & Health</option>
            <option value="party">üéâ Party & Event Supplies</option>
            <option value="books">üìö Books & Stationery</option>
          </select>
        </div>

        <div class="col">
          <label for="budget" style="color:#fff;">Budget (‚Çµ)</label>
          <input id="budget" type="number" min="0" placeholder="Enter budget amount">
        </div>
      </div>

      <!-- Item List -->
      <label for="items">Item List (name ‚Äî quantity ‚Äî price)</label>
      <textarea id="items" placeholder="Rice ‚Äî 2 ‚Äî 120 Ghs"></textarea>

      <!-- Fees Summary -->
      <div class="transparent-box" aria-live="polite">
        <div>Service Fee (20%): ‚Çµ<span id="serviceFee">0.00</span></div>
        <div>Delivery Fee: ‚Çµ<span id="deliveryFee">0.00</span></div>
        <div>Total (Budget + Service Fee + Delivery Fee): ‚Çµ<span id="totalAmount">0.00</span></div>
        <div style="margin-top:10px; font-weight:normal;">‚ö†Ô∏è Customers are responsible for delivery fees.</div>
        <div style="margin-top:12px; font-weight:normal;">
          <strong>Make payment to:</strong>
          <div>0537351866</div>
          <div>Account Name: Michael Awintini Akurugu</div>
          <div>Reference: (Customer Name)</div>
        </div>
      </div>

      <!-- Send Button -->
      <a id="sendBtn" class="send-whatsapp" 
   href="https://chat.whatsapp.com/BF5fSCyk0uaJpBKQO1ZBit" 
   onclick="openWhatsAppGroup(); return false;">
   Send Your List Now
</a>
    </form>
  </section>
</main>
<!-- Footer -->
<footer class="footer">¬© 2025 Market List ‚Äî Bringing Market to Your Doorstep</footer>

<div id="trackingPopup">
  <div class="tracking-card">
    <h2>Order Started üéâ</h2>
    <p>Your tracking code:</p>

    <div class="tracking-code-box" id="trackingCode">‚Äî</div>

    <button class="popup-btn copy-btn" id="copyTrackingBtn">Copy Tracking Code</button>
    <button class="popup-btn wa-btn" id="continueWhatsAppBtn">Send to WhatsApp</button>
    <button class="close-btn" id="closeTrackingBtn">Close</button>
  </div>
</div>


<!-- Floating Chatbot -->
<div class="chatbot-btn" onclick="toggleChat()">üí¨</div>
<div class="chat-overlay" id="chatOverlay" aria-hidden="true">
  <div class="chat-header">Chat with MarketList AI</div>
  <div class="chat-body" id="chatBody">
    <div class="chat-message bot-msg">
      Hello there üëã, welcome to <strong>MarketList!</strong><br>
      How can I assist you today?
    </div>
  </div>
  <div class="chat-input">
    <input id="chatInput" placeholder="Type your message...">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
/* ============================
   Config & Helper Utilities
   ============================ */
const GEOAPIFY_KEY = "efc8ef712d1a4cc3b5224e429987da3b";

function qs(id){ return document.getElementById(id); }
function show(el){ if(el) el.style.display = 'block'; }
function hide(el){ if(el) el.style.display = 'none'; }

/* ============================
   Preloader & Splash
   ============================ */
window.addEventListener('load', () => {
  try {
    try { sessionStorage.clear(); } catch(e){}

    const preloader = qs('preloader');
    const splash = qs('splash');

    setTimeout(() => {
      if(preloader) preloader.classList.add('hidden');
      if(splash) splash.classList.add('visible');
    }, 1200);

    setTimeout(() => { if(splash) splash.style.display = 'none'; }, 3200);
  } catch (e) {
    console.error('Preloader error', e);
    const preloader = qs('preloader'); if(preloader) preloader.style.display='none';
    const splash = qs('splash'); if(splash) splash.style.display='none';
  }
});

/* ============================
   Slider Logic
   ============================ */
let sliderIndex = 0;
const slides = document.querySelectorAll('.slide');
const dots = document.querySelectorAll('.slider-dot');

function showSlide(n){
  slides.forEach((s,i)=>s.style.display=(i===n?'block':'none'));
  dots.forEach((d,i)=>d.classList.toggle('active', i===n));
}

function nextSlide(){ 
  sliderIndex = (sliderIndex + 1) % slides.length; 
  showSlide(sliderIndex); 
}

if(slides.length){
  setInterval(nextSlide, 4000);
  showSlide(sliderIndex);
}

dots.forEach((dot, i) => dot.addEventListener('click', () => {
  sliderIndex = i;
  showSlide(i);
}));

/* ============================
   Totals & Distance Calculations
   ============================ */
let selectedLatLng = null;
let selectedMarketLatLng = null;
let selectedUserName = '';
let selectedMarketName = '';

function haversineKm(lat1,lng1,lat2,lng2){
  const R = 6371;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lng2-lng1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function getDistanceFromLatLonInKm(lat1,lng1,lat2,lng2){ return haversineKm(lat1,lng1,lat2,lng2); }

const budgetEl = qs('budget');
const serviceEl = qs('serviceFee');
const deliveryEl = qs('deliveryFee');
const totalEl = qs('totalAmount');
const savedDistanceText = qs('savedDistanceText');
const distanceInput = qs('distanceKm');

function updateTotals(){
  try {
    const budget = parseFloat(budgetEl.value) || 0;
    const service = budget * 0.2;
    let delivery = 0;
    let distance = null;

    const stored = (function(){
      try { return JSON.parse(localStorage.getItem('ml_saved_location') || 'null'); } catch(e){ return null; }
    })();

    if(stored && stored.distanceKm != null){
      distance = parseFloat(stored.distanceKm);
    } else if(selectedLatLng && selectedMarketLatLng){
      distance = getDistanceFromLatLonInKm(selectedMarketLatLng.lat, selectedMarketLatLng.lng, selectedLatLng.lat, selectedLatLng.lng);
    }

    if(distance != null && !isNaN(distance)){
      savedDistanceText.textContent = `${distance.toFixed(2)} km`;
      if(distanceInput) distanceInput.value = distance.toFixed(2);
      delivery = (distance <= 10) ? 20 : 20 + Math.ceil(distance - 10) * 2;
    } else {
      savedDistanceText.textContent = 'N/A';
      if(distanceInput) distanceInput.value = '';
      delivery = 0;
    }

    serviceEl.textContent = service.toFixed(2);
    deliveryEl.textContent = delivery.toFixed(2);
    totalEl.textContent = (budget + service + delivery).toFixed(2);
  } catch (e) {
    console.error('updateTotals error', e);
  }
}

if(budgetEl) budgetEl.addEventListener('input', updateTotals);
</script>

<!-- Hidden inputs (example, adjust according to your form) -->
<input type="hidden" id="name" value="">
<input type="hidden" id="contact" value="">
<input type="hidden" id="locationHidden" value="">
<input type="hidden" id="marketHidden" value="">
<input type="hidden" id="category" value="">
<textarea id="items"></textarea>
<span id="budget">0</span>
<span id="serviceFee">0</span>
<span id="deliveryFee">0</span>
<span id="totalAmount">0</span>

<!-- Script -->
<script>
function qs(id){ return document.getElementById(id); }

function generateTrackingCode(){
  return 'ORD-' + Math.floor(Math.random()*1000000);
}

function saveOrderToLocalStorage(order){
  let orders = JSON.parse(localStorage.getItem('ml_orders') || '[]');
  orders.push(order);
  localStorage.setItem('ml_orders', JSON.stringify(orders));
}

let lastWhatsAppMessage = '';

function prepareAndOpenWhatsApp(e){
  e.preventDefault();

  const name = (qs('name')?.value.trim()) || '';
  const contact = (qs('contact')?.value.trim()) || '';
  const locationName = qs('locationHidden')?.value || '';
  const marketName = qs('marketHidden')?.value || '';
  const category = qs('category')?.value || '';
  const items = qs('items')?.value || '';
  const budget = parseFloat(qs('budget')?.textContent || 0);
  const service = parseFloat(qs('serviceFee')?.textContent || 0);
  const delivery = parseFloat(qs('deliveryFee')?.textContent || 0);
  const total = parseFloat(qs('totalAmount')?.textContent || 0);

  if(!name || !contact){
    alert("Please fill in your name and contact number first!");
    return;
  }

  lastWhatsAppMessage = `üìù *New Market Order* üõí
üë§ Name: ${name}
üìû Contact: ${contact}
üìç Location: ${locationName}
üè¨ Market: ${marketName}
üì¶ Category: ${category}
üõç Items:
${items}
üí∞ Budget: ‚Çµ${budget}
üíµ Service Fee (20%): ‚Çµ${service}
üöö Delivery Fee: ‚Çµ${delivery}
üí≥ Total: ‚Çµ${total}`;

  const code = generateTrackingCode();

  const orderObj = {
    tracking: code,
    name, contact, location: locationName, market: marketName, category, items,
    budget, serviceFee: service, deliveryFee: delivery, total, createdAt: Date.now()
  };

  saveOrderToLocalStorage(orderObj);
  sessionStorage.setItem('ml_tracking_code', code);
  sessionStorage.setItem('ml_last_order', JSON.stringify(orderObj));

  // Open WhatsApp group
  const groupUrl = "https://chat.whatsapp.com/BF5fSCyk0uaJpBKQO1ZBit";
  window.open(groupUrl, "_blank");

  alert("Your order is prepared! Open WhatsApp group to send.");
}
</script>

<script>
/* ============================
   Load Saved Location on page start
   ============================ */
async function populateSavedLocationIfExists(){
  try{
    const payload = JSON.parse(localStorage.getItem('ml_saved_location') || 'null');

    // No saved data
    if(!payload){
      if(qs('savedCard')) qs('savedCard').style.display = 'block';
      if(qs('savedUser')) qs('savedUser').textContent = '‚Äî';
      if(qs('savedMarket')) qs('savedMarket').textContent = '‚Äî';
      if(qs('savedDistanceText')) qs('savedDistanceText').textContent = '‚Äî';
      if(qs('distanceKm')) qs('distanceKm').value = '';
      return;
    }

    /* ============================
       Normalize location keys
       ============================ */
    const userLat = payload.userLat ?? payload.customerLat ?? null;
    const userLng = payload.userLng ?? payload.customerLng ?? null;
    const marketLat = payload.marketLat ?? null;
    const marketLng = payload.marketLng ?? null;
    const payloadDistance = payload.distance ?? payload.distanceKm ?? null;

    /* ============================
       Restore coordinates
       ============================ */
    if(userLat != null && userLng != null && !isNaN(userLat) && !isNaN(userLng)){
      selectedLatLng = {
        lat: parseFloat(userLat),
        lng: parseFloat(userLng)
      };
    }

    if(marketLat != null && marketLng != null && !isNaN(marketLat) && !isNaN(marketLng)){
      selectedMarketLatLng = {
        lat: parseFloat(marketLat),
        lng: parseFloat(marketLng)
      };
    }

    /* ============================
       Resolve labels
       ============================ */
    let userName = payload.userLabel || '';
    let marketName = payload.marketLabel || '';

    if(!userName && selectedLatLng){
      try{
        userName = await reverseGeocode(
          selectedLatLng.lat,
          selectedLatLng.lng
        );
      }catch(e){}
    }

    if(!marketName && selectedMarketLatLng){
      try{
        marketName = await reverseGeocode(
          selectedMarketLatLng.lat,
          selectedMarketLatLng.lng
        );
      }catch(e){}
    }

    if(!userName && selectedLatLng){
      userName = `${selectedLatLng.lat.toFixed(5)}, ${selectedLatLng.lng.toFixed(5)}`;
    }

    if(!marketName && selectedMarketLatLng){
      marketName = `${selectedMarketLatLng.lat.toFixed(5)}, ${selectedMarketLatLng.lng.toFixed(5)}`;
    }

    selectedUserName = userName;
    selectedMarketName = marketName;

    /* ============================
       Update UI
       ============================ */
    if(qs('savedCard')) qs('savedCard').style.display = 'block';
    if(qs('savedUser')) qs('savedUser').textContent = userName || '‚Äî';
    if(qs('savedMarket')) qs('savedMarket').textContent = marketName || '‚Äî';

    if(qs('locationHidden')) qs('locationHidden').value = userName || '';
    if(qs('marketHidden')) qs('marketHidden').value = marketName || '';

    /* ============================
       Distance handling
       ============================ */
    let distanceKm = null;

    if(payloadDistance != null && !isNaN(payloadDistance)){
      distanceKm = parseFloat(payloadDistance);
    } 
    else if(selectedLatLng && selectedMarketLatLng){
      distanceKm = getDistanceFromLatLonInKm(
        selectedMarketLatLng.lat,
        selectedMarketLatLng.lng,
        selectedLatLng.lat,
        selectedLatLng.lng
      );
    }

    if(distanceKm != null && !isNaN(distanceKm)){
      if(qs('savedDistanceText')) {
        qs('savedDistanceText').textContent = `${distanceKm.toFixed(2)} km`;
      }
      if(qs('distanceKm')) qs('distanceKm').value = distanceKm.toFixed(2);
    } else {
      if(qs('savedDistanceText')) qs('savedDistanceText').textContent = 'N/A';
      if(qs('distanceKm')) qs('distanceKm').value = '';
    }

    /* ============================
       Recalculate totals
       ============================ */
    updateTotals();

  } catch (err){
    console.error('populateSavedLocationIfExists error:', err);
    if(qs('savedCard')) qs('savedCard').style.display = 'block';
  }
}

/* ============================
   Run on page load
   ============================ */
document.addEventListener('DOMContentLoaded', () => {
  populateSavedLocationIfExists();
});

/* ============================
   Patch any leftover openMap() onclicks
   ============================ */
(function patchSelectOnMapButtons(){
  try {
    const nodes = document.querySelectorAll("[onclick]");
    nodes.forEach(n=>{
      try{
        const attr = n.getAttribute('onclick') || '';
        if(attr.includes('openMap(') || attr.includes('openMap()')){
          n.setAttribute('onclick', "window.location.href='map.html'");
        }
      }catch(e){}
    });
  } catch(e){ console.warn('patchSelectOnMapButtons failed', e); }
})();

/* ============================
   Chatbot (unchanged)
   ============================ */
function toggleChat(){
  const overlay = qs('chatOverlay');
  if(!overlay) return;
  overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
}
function sendMessage(){
  const input = qs('chatInput');
  if(!input) return;
  const text = input.value.trim();
  if(!text) return;
  const chatBody = qs('chatBody');
  const userMsg = document.createElement('div'); userMsg.className='chat-message user-msg'; userMsg.textContent=text;
  chatBody.appendChild(userMsg);
  chatBody.scrollTop = chatBody.scrollHeight;
  input.value = '';
  setTimeout(()=> {
    const botMsg = document.createElement('div'); botMsg.className='chat-message bot-msg'; botMsg.textContent='ü§ñ Thanks for your message! We will get back to you shortly.';
    chatBody.appendChild(botMsg);
    chatBody.scrollTop = chatBody.scrollHeight;
  }, 800);
}
document.addEventListener('DOMContentLoaded', () => {

  const selectBtn = qs('selectOnMapBtn');
  const trackBtn  = qs('trackLocationBtn');
  const changeBtn = qs('changeLocationBtn');

  if (selectBtn) {
    selectBtn.addEventListener('click', () => {
      window.location.href = 'map.html';
    });
  }

  if (changeBtn) {
    changeBtn.addEventListener('click', () => {
      window.location.href = 'map.html';
    });
  }

  if (trackBtn) {
    trackBtn.addEventListener('click', handleTrackLocationClick);
  }

});
</script>
</body>
</html>
