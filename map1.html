<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delivery Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body, #map { height: 100%; margin: 0; padding: 0; }
  .controls {
    display: flex;
    gap: 10px;
    padding: 12px;
    background: transparent;
    justify-content: center;
    flex-wrap: wrap;
    position: absolute;
    bottom: 10px;
    width: 100%;
    z-index: 1500;
  }
  .btn {
    padding: 12px 16px;
    border-radius: 12px;
    border: 0;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn.primary { background: #1976d2; color: #fff; }
  .btn.ghost { background: #fff; border: 1px solid #eee; }
  .btn.warn { background: #d32f2f; color: #fff; }
  .status {
    position: fixed;
    left: 12px;
    bottom: 92px;
    background: rgba(255,255,255,0.95);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    z-index: 1400;
    font-size: 13px;
  }
  .top-info {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.95);
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 14px;
    text-align: center;
    z-index: 1400;
  }
</style>
</head>
<body>

<div id="map"></div>

<div class="top-info">
  <div id="destName">Customer</div>
  <div id="destAddr">Customer info</div>
  <div id="distanceRem">-- km</div>
  <div id="etaText">ETA: --</div>
  <div id="speedText">Speed: --</div>
</div>

<div class="status" id="status">Initializing...</div>

<div class="controls">
  <button id="recenterBtn" class="btn ghost">Re-center</button>
  <button id="startBtn" class="btn primary">Start Delivery</button>
  <button id="callBtn" class="btn warn">Call Customer</button>
</div>

<!-- Arrival Modal -->
<div id="arrivalModal" style="display:none; position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.15);z-index:1600;">
  <div id="arrivalSub">You are near the customer. Mark as delivered?</div>
  <div style="margin-top:12px;text-align:right;">
    <button id="arrivalYes" class="btn primary">Yes</button>
    <button id="arrivalNo" class="btn ghost">No</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function(){
const GEOAPIFY_KEY = '0bf67747adfd4bb9bfab74ec373372fb';
const START_CENTER = [5.6037, -0.1870];
const START_ZOOM = 13;
const ROUTE_REFRESH_MS = 9000;
const LIVE_UPDATE_INTERVAL_MS = 3500;
const ARRIVAL_THRESHOLD_KM = 0.06;
const ETA_FALLBACK_KMH = 40;

window._ml_map1_state = {
  map:null,userMarker:null,customerMarker:null,routeLayer:null,watchId:null,user:null,customer:null,
  tracking:null,started:false,lastRouteFetch:0,lastSpeedKmh:null
};

// DOM elements
const statusEl = document.getElementById('status');
const destNameEl = document.getElementById('destName');
const destAddrEl = document.getElementById('destAddr');
const distanceRemEl = document.getElementById('distanceRem');
const etaTextEl = document.getElementById('etaText');
const speedTextEl = document.getElementById('speedText');
const startBtn = document.getElementById('startBtn');
const recenterBtn = document.getElementById('recenterBtn');
const callBtn = document.getElementById('callBtn');
const arrivalModal = document.getElementById('arrivalModal');
const arrivalYes = document.getElementById('arrivalYes');
const arrivalNo = document.getElementById('arrivalNo');
const arrivalSub = document.getElementById('arrivalSub');

// ---------- Utils ----------
function toFixedNumber(n,d=2){return Number.parseFloat(n||0).toFixed(d);}
function haversineKm(aLat,aLon,bLat,bLon){
  const R=6371; const toRad=Math.PI/180;
  const dLat=(bLat-aLat)*toRad; const dLon=(bLon-aLon)*toRad;
  const sinDLat=Math.sin(dLat/2); const sinDLon=Math.sin(dLon/2);
  const cosALat=Math.cos(aLat*toRad); const cosBLat=Math.cos(bLat*toRad);
  const A = sinDLat*sinDLat + cosALat*cosBLat*sinDLon*sinDLon;
  const C = 2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
  return R*C;
}
function formatKm(n){ return `${toFixedNumber(n,2)} km`; }
function formatMinutes(min){ return `${Math.round(min)} min`; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

// ---------- Map init ----------
const map = L.map('map',{preferCanvas:true}).setView(START_CENTER,START_ZOOM);
window._ml_map1_state.map = map;
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
  maxZoom:20,attribution:'&copy; OpenStreetMap contributors &copy; CARTO'
}).addTo(map);

// ---------- Emoji markers ----------
function createEmojiMarker(emoji,size=40){
  return L.divIcon({
    html:`<div style="font-size:${size}px;line-height:1;text-align:center;">${emoji}</div>`,
    className:'',
    iconSize:[size,size],
    iconAnchor:[size/2,size]
  });
}
const delivererIcon = createEmojiMarker('üöö',44);
const customerIcon  = createEmojiMarker('üßçüèΩ‚Äç‚ôÇÔ∏è',40);

// ---------- Read URL params ----------
function readParams(){
  const p = new URLSearchParams(window.location.search);
  const lat = p.get('customer_lat')||p.get('lat')||null;
  const lng = p.get('customer_lng')||p.get('lng')||null;
  const label = p.get('customer_label')||p.get('name')||p.get('label')||'';
  const phone = p.get('phone')||'';
  const tracking = p.get('tracking')||'';
  const name = p.get('name')||'';
  return {
    lat: lat!=null?parseFloat(lat):null,
    lng: lng!=null?parseFloat(lng):null,
    label: decodeURIComponent(label||''),
    phone: decodeURIComponent(phone||''),
    tracking: tracking||'',
    name: decodeURIComponent(name||'')
  };
}
const params = readParams();
if(params.tracking) window._ml_map1_state.tracking = params.tracking;
if(params.lat!=null && params.lng!=null){
  window._ml_map1_state.customer={lat:params.lat,lng:params.lng,label:params.label||params.name||'',phone:params.phone||'',name:params.name||''};
} else window._ml_map1_state.customer = null;

// render customer marker
if(window._ml_map1_state.customer){
  const c = window._ml_map1_state.customer;
  destNameEl.textContent = c.label||c.name||'Customer location';
  destAddrEl.textContent = (c.phone?`Phone: ${c.phone}`:'')+(c.label?(' ‚Ä¢ '+c.label):'');
  window._ml_map1_state.customerMarker = L.marker([c.lat,c.lng],{icon:customerIcon}).addTo(map).bindPopup(escapeHtml(c.label||c.name||'Customer')).openPopup();
}

// create deliverer marker at start center
window._ml_map1_state.userMarker = L.marker(START_CENTER,{icon:delivererIcon}).addTo(map).bindPopup('Your location (deliverer)');

// ---------- Draw route ----------
async function requestRoute(fromLat,fromLng,toLat,toLng){
  const now=Date.now();
  if(now-window._ml_map1_state.lastRouteFetch<2200) return null;
  window._ml_map1_state.lastRouteFetch=now;
  const url=`https://api.geoapify.com/v1/routing?waypoints=${fromLat},${fromLng}|${toLat},${toLng}&mode=drive&format=geojson&apiKey=${GEOAPIFY_KEY}`;
  try{ const r=await fetch(url); if(!r.ok) throw new Error('Routing failed'); return await r.json(); }catch(e){console.warn('requestRoute error',e); return null;}
}

function clearRoute(){ if(window._ml_map1_state.routeLayer){try{map.removeLayer(window._ml_map1_state.routeLayer);}catch(e){} window._ml_map1_state.routeLayer=null;} }

async function drawRoute(fromLat,fromLng){
  const cust=window._ml_map1_state.customer;
  if(!cust || !isFinite(fromLat) || !isFinite(fromLng)) return;
  const res=await requestRoute(fromLat,fromLng,cust.lat,cust.lng);
  if(!res || !res.features || !res.features.length){
    const dkm=haversineKm(fromLat,fromLng,cust.lat,cust.lng);
    window._ml_map1_state.distanceKm=dkm;
    window._ml_map1_state.etaMin=(dkm/ETA_FALLBACK_KMH)*60;
    updateTopInfo();
    return;
  }
  const feat=res.features[0];
  let coords=[];
  if(feat.geometry.type==='MultiLineString') feat.geometry.coordinates.forEach(arr=>arr.forEach(c=>coords.push(c)));
  else if(feat.geometry.type==='LineString') coords=feat.geometry.coordinates.slice();
  else { const dkm=haversineKm(fromLat,fromLng,cust.lat,cust.lng); window._ml_map1_state.distanceKm=dkm; window._ml_map1_state.etaMin=(dkm/ETA_FALLBACK_KMH)*60; updateTopInfo(); return; }

  const latlngs=coords.map(c=>[c[1],c[0]]);
  clearRoute();
  window._ml_map1_state.routeLayer=L.polyline(latlngs,{color:'#1976d2',weight:6,opacity:0.95,lineJoin:'round'}).addTo(map);

  // update distance & ETA
  let distMeters=(feat.properties && typeof feat.properties.distance==='number')?feat.properties.distance:0;
  window._ml_map1_state.distanceKm=distMeters/1000;
  window._ml_map1_state.etaMin=(feat.properties && typeof feat.properties.time==='number')?feat.properties.time/60:(window._ml_map1_state.distanceKm/ETA_FALLBACK_KMH)*60;
  updateTopInfo();

  try{
    const group=L.featureGroup([L.marker([fromLat,fromLng]),L.marker([cust.lat,cust.lng])]);
    map.fitBounds(group.getBounds(),{padding:[40,40]});
  }catch(e){}
}

// ---------- Update top info ----------
function updateTopInfo(){
  const cust=window._ml_map1_state.customer;
  if(cust){ destNameEl.textContent=cust.label||cust.name||'Customer'; destAddrEl.textContent=(cust.phone?'Phone: '+cust.phone:'')+(cust.label?(' ‚Ä¢ '+cust.label):''); }
  const d=window._ml_map1_state.distanceKm;
  distanceRemEl.textContent=(d!=null)?formatKm(d):'-- km';
  etaTextEl.textContent=(window._ml_map1_state.etaMin!=null)?`ETA: ${formatMinutes(window._ml_map1_state.etaMin)}`:'ETA: --';
  speedTextEl.textContent=(window._ml_map1_state.lastSpeedKmh!=null)?`Speed: ${toFixedNumber(window._ml_map1_state.lastSpeedKmh,1)} km/h`:'Speed: --';
}

// ---------- Handle GPS ----------
function handlePosition(pos){
  const lat=pos.coords.latitude;
  const lng=pos.coords.longitude;
  const time=pos.timestamp||Date.now();
  const speedMps=(pos.coords.speed!=null&&!isNaN(pos.coords.speed))?pos.coords.speed:null;

  if(window._ml_map1_state.user && window._ml_map1_state.user.lat!=null){
    const last=window._ml_map1_state.user;
    const dkm=haversineKm(last.lat,last.lng,lat,lng);
    const dt=Math.max((time-(last.time||time))/1000,0.5);
    const kmh=dt>0?(dkm/(dt/3600)):null;
    if(kmh!=null && isFinite(kmh)) window._ml_map1_state.lastSpeedKmh=kmh;
  }else if(speedMps!=null) window._ml_map1_state.lastSpeedKmh=speedMps*3.6;

  window._ml_map1_state.user={lat,lng,time};
  try{ window._ml_map1_state.userMarker.setLatLng([lat,lng]); }catch(e){}

  updateTopInfo();

  if(window._ml_map1_state.started){
    const now=Date.now();
    if(!window._ml_map1_state.lastRouteFetch||(now-window._ml_map1_state.lastRouteFetch)>ROUTE_REFRESH_MS){
      drawRoute(lat,lng).catch(()=>{});
    }
  }else{
    if(window._ml_map1_state.customer){
      const dkm=haversineKm(lat,lng,window._ml_map1_state.customer.lat,window._ml_map1_state.customer.lng);
      window._ml_map1_state.distanceKm=dkm;
      window._ml_map1_state.etaMin=(dkm/(window._ml_map1_state.lastSpeedKmh&&window._ml_map1_state.lastSpeedKmh>1?window._ml_map1_state.lastSpeedKmh:ETA_FALLBACK_KMH))*60;
      updateTopInfo();
    }
  }

  checkArrival();
}

// ---------- Watch ----------
function startWatch(){
  if(!navigator.geolocation){ statusEl.textContent='Geolocation not available'; return; }
  if(window._ml_map1_state.watchId) return;
  window._ml_map1_state.watchId=navigator.geolocation.watchPosition(handlePosition,(err)=>{statusEl.textContent='Unable to watch position: '+(err.message||'error');},{enableHighAccuracy:true,maximumAge:2000,timeout:8000});
  statusEl.textContent='Live tracking started';
}
function stopWatch(){ if(window._ml_map1_state.watchId){navigator.geolocation.clearWatch(window._ml_map1_state.watchId);window._ml_map1_state.watchId=null;statusEl.textContent='Tracking stopped';} }

// ---------- Start Delivery ----------
startBtn.addEventListener('click',()=>{
  if(!window._ml_map1_state.user){ statusEl.textContent='Waiting for GPS fix...'; return; }
  window._ml_map1_state.started=true;
  statusEl.textContent='Delivery started';
  startBtn.disabled=true;
  drawRoute(window._ml_map1_state.user.lat,window._ml_map1_state.user.lng).catch(()=>{});
  startWatch();
});

// ---------- Re-center button ----------
recenterBtn.addEventListener('click',()=>{
  if(window._ml_map1_state.userMarker){ map.setView(window._ml_map1_state.userMarker.getLatLng(),16); }
});

// ---------- Call Customer button ----------
callBtn.addEventListener('click',()=>{
  const c=window._ml_map1_state.customer;
  if(c && c.phone){ window.location.href=`tel:${c.phone}`; } else { alert('Customer phone number not available'); }
});

// ---------- Arrival ----------
function checkArrival(){
  const user=window._ml_map1_state.user;
  const cust=window._ml_map1_state.customer;
  if(!user||!cust) return;
  const dkm=haversineKm(user.lat,user.lng,cust.lat,cust.lng);
  if(dkm<ARRIVAL_THRESHOLD_KM && !arrivalModal.classList.contains('show')){
    arrivalSub.textContent=`You are ${toFixedNumber(dkm*1000,0)} meters from the customer. Mark as delivered?`;
    arrivalModal.style.display='block';
  }
}
arrivalYes.addEventListener('click',()=>{ arrivalModal.style.display='none'; alert('Order marked delivered!'); });
arrivalNo.addEventListener('click',()=>{ arrivalModal.style.display='none'; });

// ---------- Initial GPS Fix ----------
async function getInitialGPSFix(){
  if(!navigator.geolocation) { statusEl.textContent = 'Geolocation not available'; return; }
  try {
    const pos = await new Promise((res, rej) => {
      navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 8000, maximumAge: 10000 });
    });
    handlePosition(pos);
    map.setView([pos.coords.latitude, pos.coords.longitude], 16);
    statusEl.textContent = 'GPS fix acquired. Ready for delivery.';
  } catch(e) {
    console.warn('Initial GPS fix failed', e);
    statusEl.textContent = 'Waiting for GPS fix‚Ä¶';
  }
}

getInitialGPSFix();
})();
</script>
</body>
</html>