<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deliverer ‚Äî Live Navigation</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root{
  --bg:#f7f7f7;
  --accent:#00a859;
  --accent-dark:#1976d2;
  --danger:#d32f2f;
  --card:#fff;
}
html,body,#map{height:100%;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
body{display:flex;flex-direction:column;height:100vh;background:var(--bg);}
header{background:linear-gradient(90deg,var(--accent),#ffd06b);color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;}
header h1{margin:0;font-size:16px;}
header p{margin:0;font-size:13px;opacity:0.95;}
#topInfo{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:rgba(255,255,255,0.95);box-shadow:0 8px 26px rgba(0,0,0,0.08);}
.left {display:flex;flex-direction:column;}
.dest-name{font-weight:900;}
.dest-sub{color:#666;font-size:13px;margin-top:4px;}
.right {text-align:right;min-width:140px;}
.metric{font-weight:900;font-size:18px;}
.meta{font-size:13px;color:#666;}

#map{flex:1;position:relative;}

.controls{display:flex;gap:10px;padding:12px;background:transparent;justify-content:center;flex-wrap:wrap;}
.btn{padding:12px 16px;border-radius:12px;border:0;font-weight:800;cursor:pointer;transition:all 0.2s;}
.btn.primary{background:var(--accent);color:#fff;}
.btn.ghost{background:#fff;border:1px solid #eee;}
.btn.warn{background:var(--danger);color:#fff;}
.status{position:fixed;left:12px;bottom:92px;background:rgba(255,255,255,0.95);padding:10px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:1400;font-size:13px;}

/* arrival modal */
.modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2000;}
.modal-backdrop.show{display:flex;}
.modal-card{background:var(--card);padding:20px;border-radius:12px;max-width:420px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.2);}
.modal-title{font-weight:900;font-size:18px;margin-bottom:8px;}
.modal-sub{color:#666;margin-bottom:14px;}

@media (max-width:700px){
  .right{min-width:110px;}
  .dest-name{font-size:15px;}
  .controls{flex-direction:column;align-items:center;}
}
</style>
</head>
<body>

<header>
  <div>
    <h1>Deliverer Navigation</h1>
    <p>Start delivery when you're ready ‚Äî route will follow your live location.</p>
  </div>
  <div style="text-align:right">
    <div style="font-weight:800">Mode: Deliverer</div>
    <div style="font-size:12px;opacity:0.95">Map1 (tracking)</div>
  </div>
</header>

<div id="topInfo" aria-live="polite">
  <div class="left">
    <div class="dest-name" id="destName">Loading...</div>
    <div class="dest-sub" id="destAddr">Waiting for destination</div>
  </div>
  <div class="right">
    <div class="metric" id="distanceRem">-- km</div>
    <div class="meta" id="etaText">ETA: --</div>
    <div class="meta" id="speedText">Speed: --</div>
  </div>
</div>

<div id="map"></div>

<div class="controls" role="group" aria-label="Actions">
  <button class="btn ghost" id="recenterBtn">Re-center</button>
  <button class="btn primary" id="startBtn">Start Delivery</button>
  <button class="btn" id="callBtn">Call Customer</button>
</div>

<div class="status" id="status">Preparing map‚Ä¶</div>

<!-- arrival modal -->
<div class="modal-backdrop" id="arrivalModal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div class="modal-title">You are close to the customer</div>
    <div class="modal-sub" id="arrivalSub">Mark this order as delivered?</div>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:8px">
      <button class="btn ghost" id="arrivalNo">No, continue</button>
      <button class="btn primary" id="arrivalYes">Yes, mark delivered</button>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(function(){
const GEOAPIFY_KEY = '0bf67747adfd4bb9bfab74ec373372fb';
const START_CENTER = [5.6037, -0.1870];
const START_ZOOM = 13;
const ROUTE_REFRESH_MS = 9000;
const LIVE_UPDATE_INTERVAL_MS = 3500;
const ARRIVAL_THRESHOLD_KM = 0.06;
const ETA_FALLBACK_KMH = 40;

window._ml_map1_state = {
  map:null,userMarker:null,customerMarker:null,routeLayer:null,watchId:null,user:null,customer:null,
  tracking:null,started:false,lastRouteFetch:0,lastSpeedKmh:null
};

// DOM elements
const statusEl = document.getElementById('status');
const destNameEl = document.getElementById('destName');
const destAddrEl = document.getElementById('destAddr');
const distanceRemEl = document.getElementById('distanceRem');
const etaTextEl = document.getElementById('etaText');
const speedTextEl = document.getElementById('speedText');
const startBtn = document.getElementById('startBtn');
const recenterBtn = document.getElementById('recenterBtn');
const callBtn = document.getElementById('callBtn');
const arrivalModal = document.getElementById('arrivalModal');
const arrivalYes = document.getElementById('arrivalYes');
const arrivalNo = document.getElementById('arrivalNo');
const arrivalSub = document.getElementById('arrivalSub');

// ---------- Utils ----------
function toFixedNumber(n,d=2){return Number.parseFloat(n||0).toFixed(d);}
function haversineKm(aLat,aLon,bLat,bLon){
  const R=6371; const toRad=Math.PI/180;
  const dLat=(bLat-aLat)*toRad; const dLon=(bLon-aLon)*toRad;
  const sinDLat=Math.sin(dLat/2); const sinDLon=Math.sin(dLon/2);
  const cosALat=Math.cos(aLat*toRad); const cosBLat=Math.cos(bLat*toRad);
  const A = sinDLat*sinDLat + cosALat*cosBLat*sinDLon*sinDLon;
  const C = 2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
  return R*C;
}
function formatKm(n){ return `${toFixedNumber(n,2)} km`; }
function formatMinutes(min){ return `${Math.round(min)} min`; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

// ---------- Map init ----------
const map = L.map('map',{preferCanvas:true}).setView(START_CENTER,START_ZOOM);
window._ml_map1_state.map = map;
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
  maxZoom:20,attribution:'&copy; OpenStreetMap contributors &copy; CARTO'
}).addTo(map);

// ---------- Emoji markers ----------
function createEmojiMarker(emoji,size=40){
  return L.divIcon({
    html:`<div style="font-size:${size}px;line-height:1;text-align:center;">${emoji}</div>`,
    className:'',
    iconSize:[size,size],
    iconAnchor:[size/2,size]
  });
}
const delivererIcon = createEmojiMarker('üöö',44);
const customerIcon  = createEmojiMarker('üßçüèΩ‚Äç‚ôÇÔ∏è',40);

// ---------- Read URL params ----------
function readParams(){
  const p = new URLSearchParams(window.location.search);
  const lat = p.get('customer_lat')||p.get('lat')||null;
  const lng = p.get('customer_lng')||p.get('lng')||null;
  const label = p.get('customer_label')||p.get('name')||p.get('label')||'';
  const phone = p.get('phone')||'';
  const tracking = p.get('tracking')||'';
  const name = p.get('name')||'';
  return {
    lat: lat!=null?parseFloat(lat):null,
    lng: lng!=null?parseFloat(lng):null,
    label: decodeURIComponent(label||''),
    phone: decodeURIComponent(phone||''),
    tracking: tracking||'',
    name: decodeURIComponent(name||'')
  };
}
const params = readParams();
if(params.tracking) window._ml_map1_state.tracking = params.tracking;
if(params.lat!=null && params.lng!=null){
  window._ml_map1_state.customer={lat:params.lat,lng:params.lng,label:params.label||params.name||'',phone:params.phone||'',name:params.name||''};
} else window._ml_map1_state.customer = null;

// render customer marker
if(window._ml_map1_state.customer){
  const c = window._ml_map1_state.customer;
  destNameEl.textContent = c.label||c.name||'Customer location';
  destAddrEl.textContent = (c.phone?`Phone: ${c.phone}`:'')+(c.label?(' ‚Ä¢ '+c.label):'');
  window._ml_map1_state.customerMarker = L.marker([c.lat,c.lng],{icon:customerIcon}).addTo(map).bindPopup(escapeHtml(c.label||c.name||'Customer')).openPopup();
  map.setView([c.lat,c.lng],15);
} else {
  destNameEl.textContent='No customer coordinates';
  destAddrEl.textContent='Check Tracking link';
  statusEl.textContent='Missing customer coordinates.';
}

// create deliverer marker at start center
window._ml_map1_state.userMarker = L.marker(START_CENTER,{icon:delivererIcon}).addTo(map).bindPopup('Your location (deliverer)');

// ---------- Draw route ----------
async function requestRoute(fromLat,fromLng,toLat,toLng){
  const now=Date.now();
  if(now-window._ml_map1_state.lastRouteFetch<2200) return null;
  window._ml_map1_state.lastRouteFetch=now;
  const url=`https://api.geoapify.com/v1/routing?waypoints=${fromLat},${fromLng}|${toLat},${toLng}&mode=drive&format=geojson&apiKey=${GEOAPIFY_KEY}`;
  try{ const r=await fetch(url); if(!r.ok) throw new Error('Routing failed'); return await r.json(); }catch(e){console.warn('requestRoute error',e); return null;}
}

function clearRoute(){ if(window._ml_map1_state.routeLayer){try{map.removeLayer(window._ml_map1_state.routeLayer);}catch(e){} window._ml_map1_state.routeLayer=null;} }

async function drawRoute(fromLat,fromLng){
  const cust=window._ml_map1_state.customer;
  if(!cust || !isFinite(fromLat) || !isFinite(fromLng)) return;
  const res=await requestRoute(fromLat,fromLng,cust.lat,cust.lng);
  if(!res || !res.features || !res.features.length){
    const dkm=haversineKm(fromLat,fromLng,cust.lat,cust.lng);
    window._ml_map1_state.distanceKm=dkm;
    window._ml_map1_state.etaMin=(dkm/ETA_FALLBACK_KMH)*60;
    updateTopInfo();
    return;
  }
  const feat=res.features[0];
  let coords=[];
  if(feat.geometry.type==='MultiLineString') feat.geometry.coordinates.forEach(arr=>arr.forEach(c=>coords.push(c)));
  else if(feat.geometry.type==='LineString') coords=feat.geometry.coordinates.slice();
  else { const dkm=haversineKm(fromLat,fromLng,cust.lat,cust.lng); window._ml_map1_state.distanceKm=dkm; window._ml_map1_state.etaMin=(dkm/ETA_FALLBACK_KMH)*60; updateTopInfo(); return; }

  const latlngs=coords.map(c=>[c[1],c[0]]);
  clearRoute();
  window._ml_map1_state.routeLayer=L.polyline(latlngs,{color:'#1976d2',weight:6,opacity:0.95,lineJoin:'round'}).addTo(map);

  // update distance & ETA
  let distMeters=(feat.properties && typeof feat.properties.distance==='number')?feat.properties.distance:0;
  window._ml_map1_state.distanceKm=distMeters/1000;
  window._ml_map1_state.etaMin=(feat.properties && typeof feat.properties.time==='number')?feat.properties.time/60:(window._ml_map1_state.distanceKm/ETA_FALLBACK_KMH)*60;
  updateTopInfo();

  try{
    const group=L.featureGroup([L.marker([fromLat,fromLng]),L.marker([cust.lat,cust.lng])]);
    map.fitBounds(group.getBounds(),{padding:[40,40]});
  }catch(e){}
}

// ---------- Update top info ----------
function updateTopInfo(){
  const cust=window._ml_map1_state.customer;
  if(cust){ destNameEl.textContent=cust.label||cust.name||'Customer'; destAddrEl.textContent=(cust.phone?'Phone: '+cust.phone:'')+(cust.label?(' ‚Ä¢ '+cust.label):''); }
  const d=window._ml_map1_state.distanceKm;
  distanceRemEl.textContent=(d!=null)?formatKm(d):'-- km';
  etaTextEl.textContent=(window._ml_map1_state.etaMin!=null)?`ETA: ${formatMinutes(window._ml_map1_state.etaMin)}`:'ETA: --';
  speedTextEl.textContent=(window._ml_map1_state.lastSpeedKmh!=null)?`Speed: ${toFixedNumber(window._ml_map1_state.lastSpeedKmh,1)} km/h`:'Speed: --';
}

// ---------- Handle GPS ----------
function handlePosition(pos){
  const lat=pos.coords.latitude;
  const lng=pos.coords.longitude;
  const time=pos.timestamp||Date.now();
  const speedMps=(pos.coords.speed!=null&&!isNaN(pos.coords.speed))?pos.coords.speed:null;

  if(window._ml_map1_state.user && window._ml_map1_state.user.lat!=null){
    const last=window._ml_map1_state.user;
    const dkm=haversineKm(last.lat,last.lng,lat,lng);
    const dt=Math.max((time-(last.time||time))/1000,0.5);
    const kmh=dt>0?(dkm/(dt/3600)):null;
    if(kmh!=null && isFinite(kmh)) window._ml_map1_state.lastSpeedKmh=kmh;
  }else if(speedMps!=null) window._ml_map1_state.lastSpeedKmh=speedMps*3.6;

  window._ml_map1_state.user={lat,lng,time};
  try{ window._ml_map1_state.userMarker.setLatLng([lat,lng]); }catch(e){}

  updateTopInfo();

  if(window._ml_map1_state.started){
    const now=Date.now();
    if(!window._ml_map1_state.lastRouteFetch||(now-window._ml_map1_state.lastRouteFetch)>ROUTE_REFRESH_MS){
      drawRoute(lat,lng).catch(()=>{});
    }
  }else{
    if(window._ml_map1_state.customer){
      const dkm=haversineKm(lat,lng,window._ml_map1_state.customer.lat,window._ml_map1_state.customer.lng);
      window._ml_map1_state.distanceKm=dkm;
      window._ml_map1_state.etaMin=(dkm/(window._ml_map1_state.lastSpeedKmh&&window._ml_map1_state.lastSpeedKmh>1?window._ml_map1_state.lastSpeedKmh:ETA_FALLBACK_KMH))*60;
      updateTopInfo();
    }
  }

  checkArrival();
}

// ---------- Watch ----------
function startWatch(){
  if(!navigator.geolocation){ statusEl.textContent='Geolocation not available'; return; }
  if(window._ml_map1_state.watchId) return;
  window._ml_map1_state.watchId=navigator.geolocation.watchPosition(handlePosition,(err)=>{statusEl.textContent='Unable to watch position: '+(err.message||'error');},{enableHighAccuracy:true,maximumAge:2000,timeout:8000});
  statusEl.textContent='Live tracking started';
}
function stopWatch(){ if(window._ml_map1_state.watchId){navigator.geolocation.clearWatch(window._ml_map1_state.watchId);window._ml_map1_state.watchId=null;statusEl.textContent='Tracking stopped';} }

// ---------- Start Delivery ----------
startBtn.addEventListener('click',()=>{
  if(!window._ml_map1_state.user){ statusEl.textContent='Waiting for GPS fix...'; return; }
  window._ml_map1_state.started=true;
  statusEl.textContent='Delivery started';
  startBtn.disabled=true;
  drawRoute(window._ml_map1_state.user.lat,window._ml_map1_state.user.lng).catch(()=>{});
  startWatch();
});

// ---------- Re-center button ----------
recenterBtn.addEventListener('click',()=>{
  if(window._ml_map1_state.userMarker){ map.setView(window._ml_map1_state.userMarker.getLatLng(),16); }
});

// ---------- Call Customer button ----------
callBtn.addEventListener('click',()=>{
  const c=window._ml_map1_state.customer;
  if(c && c.phone){ window.location.href=`tel:${c.phone}`; } else { alert('Customer phone number not available'); }
});

// ---------- Arrival ----------
function checkArrival(){
  const user=window._ml_map1_state.user;
  const cust=window._ml_map1_state.customer;
  if(!user||!cust) return;
  const dkm=haversineKm(user.lat,user.lng,cust.lat,cust.lng);
  if(dkm<ARRIVAL_THRESHOLD_KM && !arrivalModal.classList.contains('show')){
    arrivalSub.textContent=`You are ${toFixedNumber(dkm*1000,0)} meters from the customer. Mark as delivered?`;
    arrivalModal.classList.add('show');
  }
}
arrivalYes.addEventListener('click',()=>{ arrivalModal.classList.remove('show'); alert('Order marked delivered!'); });
arrivalNo.addEventListener('click',()=>{ arrivalModal.classList.remove('show'); });

// ---------- Initial ----------
if(window._ml_map1_state.userMarker){ map.setView(window._ml_map1_state.userMarker.getLatLng(),14); }
statusEl.textContent='Map ready. Click "Start Delivery" when ready.';
})();
</script>

</body>
</html>