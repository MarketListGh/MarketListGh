<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Reviews - MarketList</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Header (logo + nav) -->
<div class="headerbar">
  <div class="inner">
    <div class="brand" onclick="location.href='index.html'">
      <img src="logo.png" alt="logo" style="width:40px; height:auto;">
      <div class="title">MarketList</div>
    </div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="reviews.html" aria-current="page">Reviews</a>
      <a href="assistant.html">Assistant</a>
    </nav>
  </div>
</div>

<!-- Main container -->
<div class="container">
  <section class="card fade-in">
    <h1>Customer Reviews</h1>

    <!-- Review Feed -->
    <div id="reviewsFeed" aria-live="polite"></div>

    <!-- Submit Review Form -->
    <div class="review-form" aria-labelledby="reviewFormHeading">
      <h2 id="reviewFormHeading">Submit Your Review</h2>

      <label for="reviewName">Your Name</label>
      <input type="text" id="reviewName" placeholder="Enter your name" required>

      <label for="reviewLocation">Your Location</label>
      <input type="text" id="reviewLocation" placeholder="e.g., Accra, Kasoa" required>

      <label>Star Rating</label>
      <div id="starContainer" aria-label="Star rating">
        <span class="star" data-value="1" role="button" tabindex="0">â˜†</span>
        <span class="star" data-value="2" role="button" tabindex="0">â˜†</span>
        <span class="star" data-value="3" role="button" tabindex="0">â˜†</span>
        <span class="star" data-value="4" role="button" tabindex="0">â˜†</span>
        <span class="star" data-value="5" role="button" tabindex="0">â˜†</span>
      </div>

      <label for="reviewText">Your Review</label>
      <textarea id="reviewText" rows="4" placeholder="Write your review here..." required></textarea>

      <button onclick="addOrUpdateReview()">Submit Review</button>
    </div>
  </section>
</div>

<footer class="footer">Â© 2025 Market List â€” Bringing Market to Your Doorstep</footer>

<!-- Floating Chat Bubble (matches index styling & behavior) -->
<button class="chatbot-btn" id="chatToggle" aria-label="Open chat">ðŸ’¬</button>

<!-- Chat overlay (matches index: white background, same size) -->
<div class="chat-overlay" id="chatOverlay" role="dialog" aria-labelledby="chatHeader" aria-hidden="true">
  <div class="chat-header" id="chatHeader">Chat with MarketList AI</div>

  <div class="chat-body" id="chatBody">
    <!-- initial messages will be injected on load -->
  </div>

  <div class="chat-input" role="group" aria-label="Chat input">
    <input id="chatInput" placeholder="Type your message..." aria-label="Type a message">
    <button id="chatSend" aria-label="Send message">Send</button>
  </div>
</div>

<script>
/* ---------------------------
   Reviews system (unchanged behavior)
   - Edit/Delete buttons placed below review content
   - Uses localStorage 'marketReviews'
   --------------------------- */
let currentStars = 5;
let editIndex = null;
const stars = document.querySelectorAll('#starContainer .star');

function updateStarsDisplay(num){
  stars.forEach((star, i) => {
    if(i < num){
      star.textContent = 'â˜…';
      star.style.color = 'gold';
    } else {
      star.textContent = 'â˜†';
      star.style.color = 'white';
    }
  });
}

stars.forEach(star => {
  // click and keyboard friendly
  star.addEventListener('click', () => {
    currentStars = parseInt(star.getAttribute('data-value'), 10);
    updateStarsDisplay(currentStars);
  });
  star.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      currentStars = parseInt(star.getAttribute('data-value'), 10);
      updateStarsDisplay(currentStars);
    }
  });
});

updateStarsDisplay(currentStars);

function loadReviews() {
  const reviews = JSON.parse(localStorage.getItem('marketReviews')) || [];
  const feed = document.getElementById('reviewsFeed');
  feed.innerHTML = '';
  reviews.forEach((r, index) => {
    const article = document.createElement('article');
    article.style.padding = '12px 8px';
    article.style.marginBottom = '12px';
    article.style.background = 'rgba(0,0,0,0.05)';
    article.style.borderRadius = '10px';
    // build stars html
    let starsHtml = '';
    for(let i = 0; i < 5; i++){
      starsHtml += i < r.stars ? '<span style="color: gold;">â˜…</span>' : '<span style="color: white;">â˜†</span>';
    }
    article.innerHTML = `
      <p style="margin-bottom:8px"><strong>${escapeHtml(r.name)} â€” ${escapeHtml(r.location)}</strong> ${starsHtml}</p>
      <p style="margin-bottom:10px">${escapeHtml(r.text)}</p>
      <div class="review-actions" style="margin-top:0">
        <button onclick="editReview(${index})">Edit</button>
        <button onclick="deleteReview(${index})">Delete</button>
      </div>
    `;
    // newest on top
    feed.prepend(article);
  });
}

function addOrUpdateReview(){
  const name = document.getElementById('reviewName').value.trim();
  const location = document.getElementById('reviewLocation').value.trim();
  const text = document.getElementById('reviewText').value.trim();

  if(!name || !location || !text){ alert("Please fill all fields before submitting."); return; }

  const reviews = JSON.parse(localStorage.getItem('marketReviews')) || [];

  if(editIndex !== null){
    reviews[editIndex] = {name, location, text, stars: currentStars};
    editIndex = null;
  } else {
    reviews.push({name, location, text, stars: currentStars});
  }

  localStorage.setItem('marketReviews', JSON.stringify(reviews));

  document.getElementById('reviewName').value = '';
  document.getElementById('reviewLocation').value = '';
  document.getElementById('reviewText').value = '';
  currentStars = 5;
  updateStarsDisplay(currentStars);

  loadReviews();
}

function editReview(index){
  const reviews = JSON.parse(localStorage.getItem('marketReviews')) || [];
  const r = reviews[index];
  if(!r) return;
  document.getElementById('reviewName').value = r.name;
  document.getElementById('reviewLocation').value = r.location;
  document.getElementById('reviewText').value = r.text;
  currentStars = r.stars;
  updateStarsDisplay(currentStars);
  editIndex = index;
}

function deleteReview(index){
  if(!confirm("Are you sure you want to delete this review?")) return;
  const reviews = JSON.parse(localStorage.getItem('marketReviews')) || [];
  reviews.splice(index,1);
  localStorage.setItem('marketReviews', JSON.stringify(reviews));
  loadReviews();
}

// simple HTML escaping to avoid injection in reviews display
function escapeHtml(str){
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

loadReviews();

/* ---------------------------
   Chat assistant (matches Index behavior)
   - Floating bubble with centered emoji
   - Bounce animation (controlled by CSS)
   - Overlay with same size/colors as index
   - Enter to send + Send button
   - Clears chat (resets) on page load
   --------------------------- */

const chatToggle = document.getElementById('chatToggle');
const chatOverlay = document.getElementById('chatOverlay');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');

function openChat(){
  chatOverlay.style.display = 'flex';
  chatOverlay.style.flexDirection = 'column';
  chatOverlay.setAttribute('aria-hidden', 'false');
}
function closeChat(){
  chatOverlay.style.display = 'none';
  chatOverlay.setAttribute('aria-hidden', 'true');
}

chatToggle.addEventListener('click', () => {
  const isOpen = chatOverlay.style.display === 'flex';
  if(isOpen) closeChat(); else openChat();
});

// send on Enter
chatInput.addEventListener('keypress', function(e){
  if(e.key === 'Enter'){
    e.preventDefault();
    sendChatMessage();
  }
});
// send on button
chatSend.addEventListener('click', sendChatMessage);

// initial chat content (cleared on load then injected)
function resetChatIntro(){
  chatBody.innerHTML = '';
  const intro1 = document.createElement('div');
  intro1.className = 'chat-message bot-msg';
  intro1.textContent = 'ðŸ‘‹ Hello there! Welcome to MarketList. How can I assist you today?';
  const intro2 = document.createElement('div');
  intro2.className = 'chat-message bot-msg';
  intro2.textContent = 'You can ask about payment methods, how the website works, deliveries, or how to fill forms.';
  chatBody.appendChild(intro1);
  chatBody.appendChild(intro2);
  chatBody.scrollTop = chatBody.scrollHeight;
}

// basic Q/A mapping (you can expand later)
const qaPairs = {
  "what is marketlist": "MarketList is an online service that helps you order items from your local markets and have them delivered to your doorstep.",
  "how does marketlist work": "You fill out your order form, select a market, and submit. Our team buys your items and delivers them to your location.",
  "payment": "Payment can be made via mobile money to 0537351866 (Michael Awintini Akurugu). Use your name as reference.",
  "how do i pay": "You can pay via Mobile Money. Make payment to 0537351866 (Account Name: Michael Awintini Akurugu). Use your name as reference.",
  "delivery": "Deliveries depend on location and are confirmed after payment. Typical delivery times vary by area.",
  "support": "You can reach support through the WhatsApp button on the homepage or call 0537351866.",
  "default": "Thanks for your question! Our team will help with anything related to MarketList, shopping, or delivery."
};

function findAnswer(text){
  const lower = text.toLowerCase();
  // exact keys first
  for(const key in qaPairs){
    if(key !== 'default' && lower.includes(key)) return qaPairs[key];
  }
  // fallback patterns
  if(lower.includes('pay') && lower.includes('how')) return qaPairs['how do i pay'];
  if(lower.includes('payment') || lower.includes('mobile money')) return qaPairs['payment'];
  if(lower.includes('order') || lower.includes('submit')) return "After you submit your order you'll receive a confirmation; a shopper will verify and begin shopping.";
  return qaPairs['default'];
}

function sendChatMessage(){
  const msg = chatInput.value.trim();
  if(!msg) return;

  // user message
  const userDiv = document.createElement('div');
  userDiv.className = 'chat-message user-msg';
  userDiv.textContent = msg;
  chatBody.appendChild(userDiv);
  chatInput.value = '';
  chatBody.scrollTop = chatBody.scrollHeight;

  // typing indicator (three dots)
  const typing = document.createElement('div');
  typing.className = 'chat-message bot-msg';
  typing.textContent = 'MarketList is typing...';
  chatBody.appendChild(typing);
  chatBody.scrollTop = chatBody.scrollHeight;

  // simulate response delay
  setTimeout(() => {
    typing.remove();
    const botDiv = document.createElement('div');
    botDiv.className = 'chat-message bot-msg';
    botDiv.textContent = findAnswer(msg);
    chatBody.appendChild(botDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
  }, 900);
}

// reset chat on page load to keep chat short
window.addEventListener('load', () => {
  resetChatIntro();
  // ensure chat overlay is closed at start
  closeChat();
});
</script>

</body>
</html>
