<script>
/* Chatbot */
const chatOverlay = document.getElementById('chatOverlay');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');

function toggleChat() {
  const isOpen = chatOverlay.style.display === 'flex';
  chatOverlay.style.display = isOpen ? 'none' : 'flex';
  chatOverlay.style.flexDirection = 'column';
  chatOverlay.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
}

function handleKeyPress(e){
  if (e.key==='Enter'){ e.preventDefault(); sendMessage(); }
}

async function sendMessage() {
  const msg = chatInput.value.trim();
  if (!msg) return;

  // User message
  const userMsg = document.createElement('div');
  userMsg.className = 'user';
  userMsg.textContent = msg;
  chatBody.appendChild(userMsg);

  chatInput.value='';
  chatBody.scrollTop = chatBody.scrollHeight;

  // Bot placeholder
  const botMsg = document.createElement('div');
  botMsg.className = 'bot';
  botMsg.textContent = 'Typing...';
  chatBody.appendChild(botMsg);
  chatBody.scrollTop = chatBody.scrollHeight;

  try {
    const res = await fetch('https://your-server.com/chat', { // Replace with your server URL
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg })
    });
    const data = await res.json();
    botMsg.textContent = data.reply || 'Sorry, I could not get a response. Try again.';
    chatBody.scrollTop = chatBody.scrollHeight;
  } catch {
    botMsg.textContent = 'Unable to reach AI server. Please try later.';
    chatBody.scrollTop = chatBody.scrollHeight;
  }
}

/* Review system */
let currentStars = 5;
let editIndex = null;
const stars = document.querySelectorAll('#starContainer .star');
function updateStarsDisplay(num){ stars.forEach((s,i)=>{ s.textContent = i<num?'★':'☆'; s.classList.toggle('active', i<num); }); }
stars.forEach(s=>{ s.addEventListener('click', ()=>{ currentStars=parseInt(s.dataset.value); updateStarsDisplay(currentStars); }); });
updateStarsDisplay(currentStars);

function loadReviews(){
  const reviews = JSON.parse(localStorage.getItem('marketReviews'))||[];
  const feed = document.getElementById('reviewsFeed'); feed.innerHTML='';
  reviews.forEach((r,index)=>{
    const article = document.createElement('article');
    let starsHtml=''; for(let i=0;i<5;i++){ starsHtml += i<r.stars ? '<span style="color:gold">★</span>' : '<span style="color:#fff">☆</span>'; }
    article.innerHTML = `<p><strong>${escapeHtml(r.name)} — ${escapeHtml(r.location)}</strong> ${starsHtml}</p><p>${escapeHtml(r.text)}</p>
      <div class="review-actions"><button onclick="editReview(${index})">Edit</button><button onclick="deleteReview(${index})">Delete</button></div>`;
    feed.prepend(article);
  });
}

function addOrUpdateReview(){
  const name = document.getElementById('reviewName').value.trim();
  const location = document.getElementById('reviewLocation').value.trim();
  const text = document.getElementById('reviewText').value.trim();
  if(!name||!location||!text){alert('Please fill all fields.'); return;}
  const reviews = JSON.parse(localStorage.getItem('marketReviews'))||[];
  if(editIndex!==null){reviews[editIndex]={name,location,text,stars:currentStars}; editIndex=null;}
  else{reviews.push({name,location,text,stars:currentStars});}
  localStorage.setItem('marketReviews', JSON.stringify(reviews));
  document.getElementById('reviewName').value=''; document.getElementById('reviewLocation').value=''; document.getElementById('reviewText').value='';
  currentStars=5; updateStarsDisplay(currentStars); loadReviews();
}

function editReview(index){
  const reviews = JSON.parse(localStorage.getItem('marketReviews'))||[];
  const r = reviews[index]; if(!r) return;
  document.getElementById('reviewName').value=r.name;
  document.getElementById('reviewLocation').value=r.location;
  document.getElementById('reviewText').value=r.text;
  currentStars=r.stars||5; updateStarsDisplay(currentStars);
  editIndex=index;
}

function deleteReview(index){
  if(!confirm('Are you sure you want to delete this review?')) return;
  const reviews = JSON.parse(localStorage.getItem('marketReviews'))||[];
  reviews.splice(index,1);
  localStorage.setItem('marketReviews', JSON.stringify(reviews));
  loadReviews();
}

function escapeHtml(str){return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));}

/* init */
loadReviews();
</script>
